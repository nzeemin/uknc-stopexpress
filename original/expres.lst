ESPRES.SAV	38 blocks = 19 KB	12-11-91




001000: MTPS	#000340			; Запрещаем прерывания
001004: MOV	#000020, @#177722
001012: MOV	#000064, @#177462
001020: MOV	#001256, @#000130	; Адрес прерывания клавиатуры 7004
001026: MOV	#000340, @#000132	; PSW
001034: MOV	#001366, @#000060	; Адрес прерывания клавиатуры 7007
001042: MOV	#000340, @#000062	; PSW
001050: BIS	#000017, @#157720
001056: MOV	@#157720, @#177600	; Системный регистр A
001064: BIC	#000007, 157706		; цвет бордюра 0 -- чёрный
001072: MOV	157706, 177604		; Системный регистр C
001100: CLRB	157760
001104: BIC	#000010, 157706		; разрешение -- среднее
001112: MOV	157706, 177604		; пишем в Системный регистр C
001120: MOV	#003400, R0		; paper 0, ink 7
001124: MOV	#002000, R1
001130: MOV	#040000, R5		; Адрес проекции ВОЗУ
001134: BIS	#000200, @#157700	; разрешить прерывание от монитора
001142: MOV	@#157700, @#177400	; пишем в Регистр диспетчера памяти
001150: MOV	R0, (R5)+		; цикл -- очистка всего реального экрана 
001152: MOV	R0, (R5)+		;   2000 * 8. = 8192. слов = 16КБ ВОЗУ
001154: MOV	R0, (R5)+		;   /
001156: MOV	R0, (R5)+		;   /
001160: MOV	R0, (R5)+		;   /
001162: MOV	R0, (R5)+		;   /
001164: MOV	R0, (R5)+		;   /
001166: MOV	R0, (R5)+		;   /
001170: SOB	R1, 001150		; повторить
001172: BIC	#175600, @#157700	; выключить ВОЗУ из памяти
001200: MOV	@#157700, @#177400	; пишем в Регистр диспетчера памяти
001206: MTPS	#000000			; Разрешить прерывания
001212: CALL	033256			; Очистка образа экрана и формирование экрана
001216: CALL	025570			; RETURN
; Цикл распаковки последовательности демо-режима
001222: MOV	#044274, R3		; откуда
001226: MOV	#124000, R2		; куда
001232: CMPB	#000210, (R3)		; дошли до конца?
001236: BEQ	001614			;   да => переходим
001240: MOVB	(R3)+, R0		; байт для копирования
001242: MOVB	(R3)+, R1		; счётчик
001244: BIC	#177400, R1		; оставить только младший байт
001250: MOVB	R0, (R2)+		;   записываем байт
001252: SOB	R1, 001250		; повторяем
001254: BR	001232			; переходим к следующему
;
; Прерывание от клавиатуры 7004
001256: MOV    	@#177442, #000000	; Читаем состояние порта клавиатуры
001264: BIT    	#000002, 001262		; готовность приёмника
001272: BEQ    	001360
001274: MOV    	@#177440, #000000	; Читаем байт из буфера приёмника
001302: MOV    	SP, 001442
001306: BIC    	#177400, 001300		; оставляем только младший байт
001314: CMP    	001300, #000264		; код автоповтора
001322: BEQ    	001342
001324: MOV    	001300, 001454		; сохраняем нажатый код
001332: MOV    	001300, #000000
001340: RTI    				;
001342: MOV    	001336, 001454		; берём клавишу полученную в прошлый раз
001350: RTI    				;
001352: MOV    	#000064, @#177462
001360: TST    	@#177440
001364: RTI    				;
;
; Прерывание от клавиатуры 7007
001366: MOVB   	#000377, 034224		; ставим признак нажатия
001374: MOV    	#000340, 000002(SP)	; По возврату запретить прерывания
001402: RTI    				;
;
; Подпрограмма: Обработка нажатия клавиатуры
001404: MTPS	#000340			; Запрет прерываний
001410: TSTB	034224			; Было нажатие от клавиатуры 7007 ?
001414: BEQ	001426			; нет => переходим
001416: CALL	@#160004		
001422: BLO	001562
001424: BR     	001536
001426: MOV	R4, -(SP)		; сохраняем
001430: MOV	#000010, R4		; счётчик ожидания
001434: SOB	R4, 001434		; ожидание
001436: MOV	(SP)+, R4		; восстанавливаем
001440: TST	#000000			; Было нажатие от клавиатуры 7004 ?
001444: BEQ	001562			; нет => переходим
001446: CLR    	001442			; стираем признак нажатия
001452: MOV    	#000000, R0		; берём нажатую клавишу 7004
001456: CMP    	001454, #000150		; клавиша ВЫХОД ?
001464: BNE    	001472			; нет => переходим
001466: JMP    	@#172000		; нажата ВЫХОД -- выполняем сброс машины
001472: MOV    	001454, 001566		; сохраняем нажатую клавишу
001500: SUB    	#000222, 001566		; 222 - (1566) -> (1566)
001506: BMI    	001562			; меньше ноля => переходим
001510: CMP    	#000022, 001566
001516: BLO    	001562
001520: ADD    	#001570, 001566		; плюс адрес начала массива
001526: MOVB   	@001566, R0		; Получаем символ
001532: BIC    	#177400, R0		; оставляем младший байт
001536: TSTB	034224			; Было нажатие от клавиатуры 7007 ?
001542: BEQ	001552			; нет => переходим
001544: MTPS	#000340			; Запрещаем прерывания
001550: BR	001556
001552: MTPS	#000000			; Разрешаем прерывания
001556: TST	R0
001560: RETURN	
001562: CLR	R0			; возвращаем пустой символ
001564: BR	001536
001566: DW	
; Коды для расшифровки скан-кодов клавиатуры 7004
001570: DB	261, 0, 263, "1234", 264, "6", 271, "789"
;
; Сюда приходим после начальной очистки экрана и распаковки
001614: CALL	033102			; Очистка переменных
001620: CALL	025570			; RETURN
001624: CALL	033420			; Очистка образа экрана
001630: CALL	033454			; Формирование реального экрана по образу
001634: MOV	#034604, R3		; блок 200 тайлов с 000
001640: CALL	033302			; Скопировать тайлы
001644: MOV	#037006, R3		; блок 200 тайлов с 200
001650: CALL	033302			; Скопировать тайлы
001654: MOVB	#000001, @#100006	; Фаза игры "на крыше"
; Точка входа
001662: MOVB	@#100006, R0		; Фаза игры
001666: DECB	R0			; \
001670: BEQ	001676			; на крыше => переходим
001672: CALL   	002276			; Очистить экран и подготовить тайлы для фазы в вагоне
001676: CALL	025666
001702: MOVB	#000001, @#100035	; Демо-режим
001710: MOVB	#000001, @#100007	; Stage = 1
001716: MOVB	#000003, @#100010	; Lives = 3
001724: MOV	#124000, 034570		; Начало демо-последовательности
001732: MOVB	034570, @#100011
001740: MOVB	034571, @#100012
001746: MOV	#025206, 034570		; Адрес бегущей строки для демо-режима
001754: MOVB	034570, @#100013
001762: MOVB	034571, @#100014
001770: JMP	002316
; Игровой цикл, начало
001774: CLRB	@#100035		; Реальный режим (не-демо)
002000: CALL	034226			; Клавиатура
002004: BEQ	002012			; нет нажатия => переходим
002006: JMP	002316
002012: MOVB   	@#100006, R0		; фаза игры
002016: DECB   	R0
002020: BEQ    	002026			; на крыше => переходим
002022: CALL   	002276			; Очистить экран и подготовить тайлы для фазы в вагоне
002026: MOV    	#000037, R0
002032: MOVB   	R0, 034560
002036: CALL   	034226			; Клавиатура
002042: BEQ    	002050			; нет нажатия => переходим
002044: JMP    	002316
002050: MOVB   	034560, R0
002054: MOV    	#031264, R3
002060: CLR    	R2
002062: MOV    	#000040, R4		; 32. длина строки
002066: SUB    	R0, R4			; R0 - 32. -> R4
002070: MOVB   	R0, 034564		; X
002074: MOVB   	R2, 034565		; Y
002100: CALL   	033362			; Получаем в R1 адрес в образе экрана
002104: MOVB   	(R3)+, (R1)+
002106: SOB    	R4, 002104
002110: ADD    	R0, R3
002112: INC    	R2
002114: CMP    	#000030, R2		; строка 24. ?
002120: BNE    	002062			; нет => продолжаем цикл по строкам
002122: MOV    	R0, -(SP)		;
002124: CALL   	033454			; Формирование реального экрана по образу
002130: MOV    	(SP)+, R0		;
002132: DEC    	R0
002134: BPL    	002032
002136: MOV    	#070000, R1
002142: CALL   	034226			; Клавиатура
002146: BEQ    	002154
002150: JMP    	002316
002154: SOB    	R1, 002142
002156: MOV    	#000001, R0
002162: MOVB   	R0, 034560
002166: CALL   	034226			; Клавиатура
002172: BEQ    	002200
002174: JMP    	002316
002200: MOVB   	034560, R0
002204: MOV    	#031264, R3
002210: CLR    	R2
002212: ADD    	R0, R3
002214: MOV    	#000040, R4
002220: SUB    	R0, R4
002222: MOVB   	R2, 034565		; Y
002226: CLRB   	034564			; X = 0
002232: CALL   	033362
002236: MOVB   	(R3)+, (R1)+
002240: SOB    	R4, 002236
002242: INC    	R2
002244: CMP    	#000030, R2
002250: BNE    	002212
002252: MOV    	R0, -(SP)
002254: CALL   	033454			; Формирование реального экрана по образу
002260: MOV    	(SP)+, R0
002262: INC    	R0
002264: CMP    	#000040, R0
002270: BNE    	002162
002272: JMP    	001620
; Подпрограмма: Очистить экран и подготовить тайлы для фазы в вагоне
002276: CALL   	033420			; Очистка образа экрана
002302: CALL   	033454			; Формирование реального экрана по образу
002306: MOV    	#037006, R3		; блок 200 тайлов с 200
002312: JMP    	033302			; Скопировать тайлы
;
002316: MOVB	@#100006, R0		; фаза игры
002322: DECB	R0
002324: BEQ	002332			; на крыше => переходим
002326: CALL   	002276			; Очистить экран и подготовить тайлы для фазы в вагоне
002332: CALL	025570			; RETURN
002336: CALL	025666
; Начало фазы на крыше
002342: CALL	025734			; Подготовка переменных и объектов
002346: CALL	020644			; Подготовка блока тайлов поезда
002352: CALL	010044			; Опускание человечка на верёвке
002356: BHIS	002364			; флаг C снят (нет нажатия) => переходим
002360: JMP	001774			; К игровому циклу реальной игры
; Основной игровой цикл?
002364: CALL	033454			; Формирование реального экрана по образу
002370: CALL	025454			; Увеличить счётчики
002374: CALL	022322			; Скопировать блок тайлов поезда на экран план
002400: CALL	024466			; Вывод индикаторной строки вверху экрана
002404: CALL	022754			; Уменьшить оставшееся время
002410: CALL	020724			; Скроллирующийся фон
002414: CALL	021552			; Балка и CAUTION
002420: CALL	014664			; Объекты
002424: CALL	014420
002430: CALL	014034
002434: CALL	011400
002440: CALL	022050			; Вывод балки на экран
002444: CALL	024774			; Если не демо, то GAME OVER
002450: CALL	020526			; Звук
002454: CALL	025574
002460: CALL	022712			; Скроллинг насыпи под поездом
002464: CALL	021520			; Обработка счётчика скроллируемого фона
002470: CALL	015346			; Объекты
002474: CALL	011672
002500: CALL	013674
002504: CALL	014516
002510: CALL	014140
002514: CALL	014330
002520: CALL	022202			; Появление и движение балки
002524: CALL	023002
002530: MOVB	@#100034, R0
002534: CMPB	R0, #000002
002540: BNE	002546
002542: JMP    	006202			; Переход к игровому циклу: падение человечка с поезда
002546: TSTB	R0
002550: BEQ	002556
002552: JMP	005160
002556: TSTB	@#100035		; демо-режим?
002562: BEQ	002612			; да => переходим
002564: CALL   	034226			; Клавиатура
002570: BEQ    	002576			; нет нажатия => переходим
002572: JMP    	001774			; есть нажатие => переходим
002576: MOVB   	@#100035, R0		; берём признак демо-режима
002602: INCB   	R0			; (100035) = 377 ?
002604: BNE    	002612			; нет => переходим
002606: JMP    	001774
002612: CMPB	@#100155, #000012	; вагон < 10. ?
002620: BLO	002364			; да => повтор
002622: MOVB   	#000017, @#100041	; Положение человечка X = 15.
002630: MOVB   	#000007, @#100042	; Положение человечка Y = 7
002636: CLR    	@#100044
002642: CLRB   	@#100051
002646: MOVB   	#000377, @#100050	; DX = -1 -- влево
; Игровой цикл -- ???
002654: CALL   	033454			; Формирование реального экрана по образу
002660: CALL   	025454			; Увеличить счётчики
002664: CALL   	022322			; Скопировать блок тайлов поезда на экран план
002670: CALL   	024466			; Вывод индикаторной строки вверху экрана
002674: CALL   	020724			; Скроллирующийся фон
002700: CALL   	021552			; Балка и CAUTION
002704: CALL   	020526			; Звук
002710: CALL   	025574
002714: CALL   	014420
002720: CALL   	014034
002724: CALL   	011400
002730: CALL   	022050			; Вывод балки на экран
002734: CALL   	011256
002740: CALL   	024774			; Если не демо, то GAME OVER
002744: CALL   	022712			; Скроллинг насыпи под поездом
002750: CALL   	021520			; Обработка счётчика скроллируемого фона
002754: CALL   	014516
002760: CALL   	014140
002764: CALL   	022202			; Появление и движение балки
002770: TSTB   	@#100016		; Проверяем быстрый счётчик
002774: BNE    	002654			; не ноль => повторяем цикл
002776: CALL   	013224
003002: DECB   	@#100041		; Положение человечка X на 1 меньше
003006: BNE    	002654
003010: CALL   	006160			; RETURN
003014: CALL   	033454			; Формирование реального экрана по образу
003020: CALL   	025454			; Увеличить счётчики
003024: CALL   	022322			; Скопировать блок тайлов поезда на экран план
003030: CALL   	024466			; Вывод индикаторной строки вверху экрана
003034: CALL   	020724			; Скроллирующийся фон
003040: CALL   	021552			; Балка и CAUTION
003044: CALL   	020526			; Звук
003050: CALL   	006162			; RETURN
003054: CALL   	025574
003060: CALL   	014420
003064: CALL   	014034
003070: CALL   	011400
003074: CALL   	022050			; Вывод балки на экран
003100: CALL   	011350
003104: CALL   	011256
003110: CALL   	024774			; Если (100035)<>0 то GAME OVER
003114: CALL   	022712			; Скроллинг насыпи под поездом
003120: CALL   	021520			; Обработка счётчика скроллируемого фона
003124: CALL   	014516
003130: CALL   	014140
003134: CALL   	022202			; Появление и движение балки
003140: TSTB   	@#100016
003144: BNE    	003014
003146: MOVB   	@#100042, R0		; Положение человечка Y
003152: CMPB   	R0, #000014		; равно 12. ?
003156: BEQ    	003170			; да => переходим
003160: INCB   	R0			; вниз на 1 строку
003162: MOVB   	R0, @#100042		; Сохраняем положение человечка Y
003166: BR     	003014
003170: CALL   	011020
003174: MOV    	#002200, @#100174
003202: MOVB   	#000003, @#100176
003210: CALL   	025454			; Увеличить счётчики
003214: CALL   	022322			; Скопировать блок тайлов поезда на экран план
003220: CALL   	024466			; Вывод индикаторной строки вверху экрана
003224: CALL   	020724			; Скроллирующийся фон
003230: CALL   	021552			; Балка и CAUTION
003234: CALL   	022050			; Вывод балки на экран
003240: CALL   	024774			; Если (100035)<>0 то GAME OVER
003244: CALL   	022712			; Скроллинг насыпи под поездом
003250: CALL   	021520			; Обработка счётчика скроллируемого фона
003254: CALL   	022202			; Появление и движение балки
003260: CALL   	020526			; Звук
003264: CALL   	033454			; Формирование реального экрана по образу
003270: CMPB   	@#100155, #000013	; 11.
003276: BNE    	003306
003300: TSTB   	@#100154
003304: BEQ    	003326
003306: TSTB   	@#100015
003312: BNE    	003210
003314: CALL   	020134			; Скроллирование поезда вправо
003320: CALL   	026740
003324: BR     	003210
; Переключение на фазу 2 -- в вагоне
003326: CALL   	025570			; RETURN
003332: CALL   	033420			; Очистка образа экрана
003336: CALL   	033454			; Формирование реального экрана по образу
003342: MOV    	#041210, R3		; блок 200 тайлов с 200 тайла
003346: CALL   	033302			; Скопировать тайлы
003352: CALL   	026156			; Подготовка переменных и объектов
003356: CALL   	020644			; Подготовка блока тайлов поезда
003362: CALL   	010470
003366: BHIS   	003374			; флаг C снят (нет нажатия) => переходим
003370: JMP    	001774			; К игровому циклу реальной игры
; Начало игрового цикла -- в вагоне
003374: CALL   	033454			; Формирование реального экрана по образу
003400: CALL   	025454			; Увеличить счётчики
003404: CALL   	022322			; Скопировать блок тайлов поезда на экран план
003410: CALL   	024466			; Вывод индикаторной строки вверху экрана
003414: CALL   	022754			; Уменьшить оставшееся время
003420: CALL   	020724			; Скроллирующийся фон
003424: CALL   	021552			; Балка и CAUTION
003430: CALL   	014664			; Объекты
003434: CALL   	020072
003440: CALL   	016762			; Вывод привидения
003444: CALL   	017526
003450: CALL   	011400
003454: CALL   	022462			; Рисуем тамбур-переход для фазы в вагоне
003460: CALL   	024774			; Если демо то GAME OVER
003464: CALL   	020526			; Звук
003470: CALL   	025574
003474: CALL   	022712			; Скроллинг насыпи под поездом
003500: CALL   	021520			; Обработка счётчика скроллируемого фона
003504: CALL   	022202			; Появление и движение балки
003510: CALL   	011672
003514: CALL   	013674
003520: CALL   	017154
003524: CALL   	017650
003530: CALL   	015346			; Объекты
003534: CALL   	023606
003540: TSTB   	@#100034
003544: BEQ    	003552
003546: JMP    	007052
003552: TSTB   	@#100035		; демо-режим?
003556: BEQ    	003606			; нет => переходим
003560: CALL   	034226			; Клавиатура
003564: BEQ    	003572			; нет нажатия => переходим
003566: JMP    	001774			; есть нажатие => переходим
003572: MOVB   	@#100035, R0		; берём признак демо-режима
003576: INCB   	R0			; (100035) = 377 ?
003600: BNE    	003606			; нет => переходим
003602: JMP    	001774
003606: TSTB   	@#100036
003612: BNE    	003620
003614: JMP    	003374			; на повтор игрового цикла
003620: TSTB   	@#100037
003624: BNE    	003632
003626: JMP    	003374			; на повтор игрового цикла
003632: CMPB   	@#100041, #000002	; Положение человечка = 2 ?
003640: BEQ    	003646			; к экрану CONGRATULATIONS
003642: JMP    	003374			; на повтор игрового цикла
; Игровой экран CONGRATULATIONS -- подготовка
003646: CALL   	011020
003652: CALL   	033420			; Очистка образа экрана
003656: CALL   	033454			; Формирование реального экрана по образу
003662: MOV    	#043412, R3		; блок 060 тайлов с 260 тайла
003666: CALL   	033302			; Скопировать тайлы
; Игровой цикл CONGRATULATIONS
003672: CALL   	025454			; Увеличить счётчики
003676: CALL   	022322			; Скопировать блок тайлов поезда на экран план
003702: CALL   	004450
003706: CALL   	024466			; Вывод индикаторной строки вверху экрана
003712: CALL   	020724			; Скроллирующийся фон
003716: CALL   	021552			; Балка и CAUTION
003722: CALL   	022050			; Вывод балки на экран
003726: CALL   	004572			; Вывод строки CONGRATULATION
003732: CALL   	024774			; Если демо то GAME OVER
003736: CALL   	020526			; Звук
003742: CALL   	025574
003746: CALL   	022712			; Скроллинг насыпи под поездом
003752: CALL   	021520			; Обработка счётчика скроллируемого фона
003756: CALL   	022202			; Появление и движение балки
003762: CALL   	033454			; Формирование реального экрана по образу
003766: TSTB   	@#100016
003772: BNE    	003672
003774: CALL   	020134			; Скроллирование поезда вправо
004000: CMPB   	@#100155, #000025	; номер вагона = 21. ?
004006: BNE    	003672
004010: MOVB   	@#100154, R0
004014: DECB   	R0
004016: BNE    	003672
004020: MOV    	#000400, @#100174
004026: MOV    	#020000, @#100176
004034: CALL   	025454			; Увеличить счётчики
004040: CALL   	022322			; Скопировать блок тайлов поезда на экран план
004044: CALL   	004450
004050: CALL   	024466			; Вывод индикаторной строки вверху экрана
004054: CALL   	020724			; Скроллирующийся фон
004060: CALL   	021552			; Балка и CAUTION
004064: CALL   	022050			; Вывод балки на экран
004070: CALL   	004572			; Вывод строки CONGRATULATION
004074: CALL   	024774			; Если демо то GAME OVER
004100: CALL   	033454			; Формирование реального экрана по образу
004104: CMPB   	@#100175, #000002
004112: BHIS   	004144
004114: CALL   	020526			; Звук
004120: CALL   	025574
004124: CALL   	022712			; Скроллинг насыпи под поездом
004130: CALL   	021520			; Обработка счётчика скроллируемого фона
004134: CALL   	022202			; Появление и движение балки
004140: JMP    	004250
004144: MOV    	#100174, R3
004150: CALL   	025554			; Увеличить счётчик R3
004154: BLO    	004250
004156: CALL   	020526			; Звук
004162: MOVB   	@#101075, R0
004166: MOV    	#101101, R3
004172: MOV    	#101102, R2
004176: MOV    	#000037, R1
004202: MOVB   	-(R3), -(R2)
004204: SOB    	R1, 004202
004206: MOVB   	R0, -(R2)
004210: DEC    	@#100162
004214: MOV    	@#100162, R3
004220: ADD    	#021126, R3
004224: TSTB   	(R3)
004226: BNE    	004236
004230: MOV    	#000124, @#100162
004236: TSTB   	@#100164		; На экране есть балка?
004242: BEQ    	004250			;   нет => переходим
004244: INCB   	@#100165		; сдвигаем балку вправо на 1
004250: MOV    	#100176, R3
004254: CALL   	025554			; Увеличить счётчик R3
004260: BHIS   	004266
004262: JMP    	004034			; повтор
;
004266: INCB   	@#100175
004272: CMPB   	@#100175, #000012
004300: BLO    	004262
004302: CLR    	R1
004304: DEC    	R1
004306: SOB    	R1, 004306		; ожидание
004310: CALL   	025570			; RETURN
004314: CLRB   	@#100172
004320: MOV    	#000377, R1		; Счётчик цикла = 255.
004324: MOV    	R1, -(SP)		; Начало цикла, сохраняем R1
004326: CALL   	025454			;   Увеличить счётчики
004332: CALL   	022322			;   Скопировать блок тайлов поезда на экран план
004336: CALL   	004450
004342: CALL   	004754
004346: CALL   	024466			;   Вывод индикаторной строки вверху экрана
004352: CALL   	020724			;   Скроллирующийся фон
004356: CALL   	021552			;   Балка и CAUTION
004362: CALL   	022050			;   Вывод балки на экран
004366: CALL   	004606			;   Вывод строки THE TRAIN IS STOPPED
004372: CALL   	024774			;   Если демо то GAME OVER
004376: CALL   	005124
004402: CALL   	033454			;   Формирование реального экрана по образу
004406: MOV    	(SP)+, R1		;   восстанавливаем R1
004410: SOB    	R1, 004324		; повторение цикла
004412: CALL   	033420			; Очистка образа экрана
004416: CALL   	033454			; Формирование реального экрана по образу
004422: MOV    	#037006, R3		; блок 200 тайлов с 200
004426: CALL   	033302			; Скопировать тайлы
004432: TSTB   	@#100035		; демо-режим?
004436: BNE    	004440			; да => переходим
004440: INCB   	@#100007		; Stage += 1
004444: JMP    	002342			; Переход на начало раунда
; Подпрограмма
004450: MOV    	#030300, R3
004454: CLRB   	034564
004460: MOVB   	#000011, R4		; Y = 9.
004464: CMPB   	@#100155, #000025	; номер вагона = 21. ?
004472: BEQ    	004550
004474: MOVB   	@#100154, R0
004500: BEQ    	004546			; ноль => на выход
004502: MOV    	#000040, R2		; \
004506: SUB    	R0, R2			; 32. - R2 -> R2
004510: MOV    	R0, -(SP)		; сохраняем R0
004512: ADD    	R2, R3
004514: MOVB   	R4, 034565		; Y
004520: CALL   	033362			; Получаем в R1 адрес в образе экрана
004524: MOV    	#000012, R0		; NOTE: Эта строчка лишняя!!!!!
004530: MOVB   	(R3)+, (R1)+		;   копируем
004532: SOB    	R0, 004530		; повторяем
004534: MOV    	(SP)+, R0		; восстанавливаем R0
004536: INC    	R4
004540: CMP    	R4, #000027		; 23.
004544: BLO    	004510
004546: RETURN 	
004550: MOVB   	R4, 034565		; Y
004554: CALL   	033362			; Получаем в R1 адрес в образе экрана
004560: MOV    	#000700, R2		; Счётчик = 448. = 14. строк
004564: MOVB   	(R3)+, (R1)+		;   копируем
004566: SOB    	R2, 004564		; повторяем
004570: RETURN 	
;
004572: MOV    	#004622, R3		; Адрес строки CONGRATULATION
004576: MOV    	#101310, R1
004602: JMP    	034366			; Печать строки
;
004606: MOV    	#004657, R3		; Адрес строки THE TRAIN IS STOPPED
004612: MOV    	#101313, R1
004616: JMP    	034366			; Печать строки
;
004622: DB      "CONGRATULATION!", 011
004642: DB      "YOU SUCSESS!", 000
004657: DB	"THE TRAIN IS STOPPED!", 000

004706: TSTB   	@#100035		; демо-режим?
004712: BEQ    	004716			; нет => Вывод строки TRY NEXT ROUND
004714: RETURN 	
004716: MOV    	#004732, R3		; Адрес строки TRY NEXT ROUND
004722: MOV    	#101716, R1
004726: JMP    	034366
004732: DB	"TRY NEXT ROUND!", 000, 000
;
; Подпрограмма
004754: TSTB   	@#100172
004760: BNE    	004764
004762: RETURN 	
004764: MOV    	#101756, R1
004770: MOV    	R1, -(SP)
004772: CALL   	005102
004776: MOV    	(SP)+, R1
005000: INC    	R1
005002: CMPB   	@#100172, #000002
005010: BLO    	005016
005012: CALL   	005102
005016: MOV    	#102116, R1
005022: CMPB   	@#100172, #000005
005030: BLO    	004762
005032: BEQ    	005044
005034: MOV    	#005064, R3		; Спрайт
005040: JMP    	025402			; Вывод спрайта
005044: MOV    	#005052, R3		; Спрайт
005050: BR     	005040			; на Вывод спрайта
; Спрайт
005052:	.BYTE	203,040,307,204,040,331,204,000,000,000
; Спрайт
005064: .BYTE	201,001,203,037,222,001,223,037,242,001,243,000,000,000
;
005102: MOV    	#000177, R0
005106: MOV    	#000006, R2
005112: MOVB   	R0, (R1)
005114: ADD    	#000040, R1
005120: SOB    	R2, 005112
005122: RETURN 	
005124: TSTB   	@#100022
005130: BNE    	005146
005132: CMPB   	@#100172, #000006
005140: BHIS   	005146
005142: INCB   	@#100172
005146: RETURN 	
005150: MOVB   	@000000(R4), R0
005154: RSEL   	
005156: JSR    	R5, R0
005160: CALL	025570			; RETURN
005164: CALL	006160			; RETURN
005170: CLRB	@#100065
005174: CLRB	@#100061
005200: MOV	#002000, @#100174
005206: MOV	#000400, @#100176
005214: MOV	#010000, @#100200	; Счётчик
005222: CLR	R1
; Игровой цикл -- падение человечка с поезда
005224: MOV	R1, -(SP)
005226: CALL	033454			; Формирование реального экрана по образу
005232: CALL	025454			; Увеличить счётчики
005236: CALL	022322			; Скопировать блок тайлов поезда на экран план
005242: CALL	024466			; Вывод индикаторной строки вверху экрана
005246: CALL	020724			; Скроллирующийся фон
005252: CALL	021552			; Балка и CAUTION
005256: CALL	005752			; Выводим человечка в падении
005262: CALL	014664			; Объекты
005266: CALL	015346			; Объекты
005272: CALL	014034
005276: CALL	014140
005302: CALL	022050			; Вывод балки на экран
005306: CALL	024774			; Если демо-режим, то GAME OVER
005312: MOV	#100200, R3		; \
005316: CALL	025554			; Увеличить счётчик (100200)
005322: TSTB	@#100175
005326: BNE	005342
005330: CALL	020322			; Скроллирование поезда влево
005334: CALL	020322			; Скроллирование поезда влево
005340: BR	005372
005342: MOV	#100174, R3
005346: CALL	025554
005352: BLO	005360
005354: CALL	020322			; Скроллирование поезда влево
005360: TSTB	@#100200		; Счётчик дошёл до конца?
005364: BNE	005372			; нет => переходим
005366: DECB	@#100175
005372: TSTB	@#100175
005376: BEQ	005416
005400: CALL	022712			; Скроллинг насыпи под поездом
005404: CALL	021520			; Обработка счётчика скроллируемого фона
005410: CALL	022202			; Появление и движение балки
005414: BR	005540
005416: CMPB	@#100177, #000004
005424: BHIS	005540
005426: MOV	#100176, R3		; \
005432: CALL	025554			; Увеличить счётчик (100176)
005436: BLO	005526
005440: MOVB	@#101075, R0
005444: MOV	#101101, R3
005450: MOV	#101102, R2
005454: MOV	#000037, R1		; Счётчик = 31.
005460: MOVB	-(R3), -(R2)		;   копируем
005462: SOB	R1, 005460		l повторяем
005464: MOVB	R0, -(R2)
005466: DEC	@#100162
005472: MOV	@#100162, R3
005476: ADD	#021126, R3
005502: TSTB	(R3)
005504: BNE	005514
005506: MOV	#000124, @#100162
005514: TSTB	@#100164		; На экране есть балка?
005520: BEQ	005526			;   нет => переходим
005522: INCB   	@#100165		; сдвигаем балку вправо на 1
005526: TSTB	@#100200
005532: BNE	005540
005534: INCB	@#100177
005540: CMPB	@#100177, #000004
005546: BHIS	005566
005550: TSTB	@#100176
005554: BNE	005566
005556: MOV	#100061, R3
005562: CALL	025554
005566: MOVB	@#100042, R0		; Положение человечка Y
005572: CMPB	R0, #000025		; равно 21. ?
005576: BEQ	005650			; да => переходим
005600: INCB	R0			; ниже на 1 строку
005602: MOVB	R0, @#100042		; Сохраняем Положение человечка Y
005606: CMPB	R0, #000025
005612: BEQ	005630
005614: TSTB	@#100035		; демо-режим?
005620: BNE	005650			; да => переходим
005622: CALL	006162			; RETURN
005626: BR	005650
005630: CALL	025570			; RETURN
005634: MOVB	#000001, @#100040
005642: MOV	#033070, @#100032
005650: CALL	020526			; Звук
005654: TSTB	@#100030
005660: BNE	005666
005662: CALL	025574
005666: MOVB	@#100035, R0		; демо-режим?
005672: BEQ	005700			; нет => переходим
005674: CALL   	034226			; Клавиатура
005700: MOV	(SP)+, R1
005702: TSTB	@#100035		; демо-режим?
005706: BEQ	005720			; нет => переходим
005710: TSTB   	R0			; нажата клавиша?
005712: BEQ    	005720			; нет => переходим
005714: JMP    	001774			; да => переходим
005720: DECB	R1
005722: BEQ	005730
005724: JMP	005224
005730: CALL	025570			; RETURN
005734: DECB	@#100010		; Уменьшаем счётчик жизней
005740: BEQ	005746			; нет жизней => переходим
005742: JMP	002342			; Начинаем новый раунд
005746: JMP    	007720			; нет больше жизней
; Подпрограмма: Выводим человечка в падении
005752: MOVB	@#100041, R1		; Положение человечка X
005756: MOVB	@#100042, 034565	; Положение человечка Y сохраняем
005764: CMPB	R1, #000040		; X > 32. ?
005770: BLO	005774
005772: RETURN 	
005774: CMPB	R1, #000036
006000: BLO	006006
006002: MOVB   	#000035, R1
006006: BITB	#000001, @#100061
006014: BEQ	006022
006016: INCB	034565			; Y++
006022: MOVB	R1, 034564		; X
006026: CALL	033362			; Получаем в R1 адрес в образе экрана
006032: MOV	#006074, R3		; Спрайт человечка в падении, фаза 0
006036: MOVB	@#100061, R0		; фаза человечка в падении
006042: BEQ	006070
006044: MOV	#006111, R3		; Спрайт человечка в падении, фаза 1
006050: DECB	R0
006052: BEQ	006070
006054: MOV	#006126, R3		; Спрайт человечка в падении, фаза 2
006060: DECB	R0
006062: BEQ	006070
006064: MOV	#006143, R3		; Спрайт человечка в падении, фаза 3
006070: JMP	025402			; Вывод спрайта
; Спрайты человечка в падении, 4 фазы
006074: .BYTE	300,001,301,037,320,001,321,037,340,001,341,000,000
006111:	.BYTE	302,001,303,001,304,036,322,001,323,001,324,000,000
006126:	.BYTE	305,001,306,037,325,001,326,037,345,001,346,000,000
006143: .BYTE	307,001,310,001,311,036,327,001,330,001,331,000,000
;
006160: RETURN	
006162: RETURN	

; Подготовка игрового цикла: человечек в падении, поезд уезжает
006202: CLRB   	@#100065
006206: CLRB   	@#100061
006212: MOV    	#000400, @#100174
006220: MOV    	#001000, @#100176
006226: MOV    	#003000, @#100200
006234: CLRB   	@#100172
006240: MOVB   	#000050, @#100173
006246: MOVB   	#000050, @#101104
006254: CLR    	R1
; Начало цикла
006256: MOV    	R1, -(SP)
006260: CALL   	033454
006264: CALL   	006446
006270: CALL   	025454			; Увеличить счётчики
006274: CALL   	022322
006300: CALL   	024466
006304: CALL   	020724			; Скроллирующийся фон
006310: CALL   	021552			; Балка и CAUTION
006314: CALL   	005752			; Выводим человечка в падении
006320: CALL   	014664			; Объекты
006324: CALL   	015346			; Объекты
006330: CALL   	014034
006334: CALL   	014140
006340: CALL   	022050			; Вывод балки на экран
006344: CALL   	020322			; Скроллирование поезда влево
006350: CALL   	020322			; Скроллирование поезда влево
006354: CALL   	024774
006360: TSTB   	@#100030
006364: BNE    	006372
006366: CALL   	025574
006372: TSTB   	@#100035
006376: BNE    	006516
006400: MOVB   	@#100172, R1
006404: MOVB   	@#100173, R0
006410: BMI    	006430
006412: ADD    	R1, R0
006414: BIT    	#177400, R0
006420: BNE    	006512
006422: MOVB   	R0, @#100172
006426: BR     	006516
006430: ADD    	R1, R0
006432: BIT    	#177400, R0
006436: BNE    	006512
006440: MOVB   	R0, @#100172
006444: BR     	006516
006446: TSTB   	@#101104
006452: BNE    	006456
006454: RETURN 	
006456: CLRB   	@#101104
006462: MOV    	#000764, R2
006466: MOV    	#000012, R1
006472: CALL   	034300
006476: MOV    	#001130, R2
006502: MOV    	#000017, R1
006506: JMP    	034300
006512: NEGB   	@#100173
006516: CMPB   	@#100175, #000020
006524: BHIS   	006646
006526: MOV    	#100174, R3
006532: CALL   	025554
006536: BLO    	006646
006540: CMPB   	@#100042, #000025
006546: BHIS   	006646
006550: MOVB   	@#101046, R0
006554: MOV    	#101043, R3
006560: MOV    	#101042, R2
006564: MOV    	#000037, R1		; Счётчик = 31. -- строка минус 1
006570: MOVB   	(R3)+, (R2)+		;   переносим один тайл
006572: SOB    	R1, 006570		; повторяем
006574: MOVB   	R0, (R2)		; новый тайл
006576: INC    	@#100162
006602: MOV    	@#100162, R3
006606: ADD    	#177653, R3
006612: BNE    	006620
006614: CLR    	@#100162
006620: TSTB   	@#100164		; На экране есть балка?
006624: BEQ    	006646			;   нет => переходим
006626: DECB   	@#100165		; сдвигаем балку влево на 1
006632: CMPB   	@#100165, #000040	; за пределами строки?
006640: BLO    	006646			;   нет => переходим
006642: CLRB   	@#100164		; убираем балку с экрана
006646: MOV    	#100176, R3
006652: CALL   	025554
006656: BLO    	006722
006660: MOVB   	@#100042, R0
006664: CMPB   	R0, #000025
006670: BHIS   	006722
006672: INCB   	R0
006674: MOVB   	R0, @#100042
006700: CMPB   	R0, #000025
006704: BNE    	006722
006706: MOVB   	#000001, @#100040
006714: MOV    	#033070, @#100032
006722: CMPB   	@#100175, #000020
006730: BHIS   	006750
006732: MOV    	#100200, R3
006736: CALL   	025554
006742: BLO    	006750
006744: INCB   	@#100175
006750: TSTB   	@#100035
006754: BEQ    	006762
006756: CALL   	034226			; клавиатура
006762: MOV    	(SP)+, R1
006764: TSTB   	@#100035
006770: BEQ    	007002
006772: TSTB   	R0			; нажата клавиша?
006774: BEQ    	007002			; нет => переходим
006776: JMP    	001774			; да => переходим
007002: DECB   	R1
007004: BEQ    	007012
007006: JMP    	006256
007012: CALL   	025570
007016: DECB   	@#100010
007022: BEQ    	007030
007024: JMP    	002342
007030: JMP    	007720
;
007052: CALL   	025570
007056: CMPB   	@#100042, #000021
007064: BLO    	007074
007066: MOVB   	#000020, @#100042
007074: CLRB   	@#100061
007100: MOVB   	@#100034, R0
007104: INCB   	R0
007106: BNE    	007114
007110: JMP    	007306
007114: MOV    	#007702, R3
007120: CALL   	025572			; RETURN
007124: MOV    	#000100, R1
007130: MOV    	R1, -(SP)
007132: CALL   	033454
007136: CALL   	025454			; Увеличить счётчики
007142: CALL   	022322
007146: CALL   	024466
007152: CALL   	020724			; Скроллирующийся фон
007156: CALL   	021552			; Балка и CAUTION
007162: CALL   	005752			; Выводим человечка в падении
007166: CALL   	014664			; Объекты
007172: CALL   	020072
007176: CALL   	016762			; Вывод привидения
007202: CALL   	017526
007206: CALL   	022462			; Рисуем тамбур-переход для фазы в вагоне
007212: CALL   	024774
007216: CALL   	022712			; Скроллинг насыпи под поездом
007222: CALL   	021520
007226: CALL   	022202			; Появление и движение балки
007232: CALL   	017154
007236: TSTB   	@#100035
007242: BEQ    	007250
007244: CALL   	034226			; клавиатура
007250: MOV    	(SP)+, R1
007252: TSTB   	@#100035
007256: BEQ    	007270
007260: TSTB   	R0			; нажата клавиша?
007262: BEQ    	007270			; нет => переходим
007264: JMP    	001774			; да => переходим
007270: SOB    	R1, 007130
007272: MOVB   	#000001, @#100040
007300: MOV    	#033056, @#100032
007306: MOV    	#000062, R1
007312: MOV    	R1, -(SP)
007314: CALL   	033454
007320: CALL   	025454			; Увеличить счётчики
007324: CALL   	022322
007330: CALL   	024466
007334: CALL   	020724			; Скроллирующийся фон
007340: CALL   	021552			; Балка и CAUTION
007344: CALL   	020072
007350: CALL   	005752			; Выводим человечка в падении
007354: CALL   	022462			; Рисуем тамбур-переход для фазы в вагоне
007360: CALL   	024774
007364: CALL   	022712			; Скроллинг насыпи под поездом
007370: CALL   	021520
007374: CALL   	022202
007400: CALL   	020526			; Звук
007404: TSTB   	@#100016
007410: BNE    	007452
007412: MOV    	#100061, R3
007416: CALL   	025554
007422: CALL   	025574
007426: MOVB   	@#100040, R0
007432: BNE    	007452
007434: INCB   	R0
007436: MOVB   	R0, @#100040
007442: MOV    	#033056, @#100032
007450: BR     	007422
007452: TSTB   	@#100035
007456: BEQ    	007464
007460: CALL   	034226			; клавиатура
007464: MOV    	(SP)+, R1
007466: TSTB   	@#100035
007472: BEQ    	007504
007474: TSTB   	R0			; нажата клавиша?
007476: BEQ    	007504			; нет => переходим
007500: JMP    	001774			; да => переходим
007504: SOB    	R1, 007312
007506: MOVB   	#000001, @#100040
007514: MOV    	#033070, R3
007520: MOV    	#000106, R1
007524: MOV    	R1, -(SP)
007526: CALL   	033454
007532: CALL   	025454			; Увеличить счётчики
007536: CALL   	022322
007542: CALL   	024466
007546: CALL   	020724			; Скроллирующийся фон
007552: CALL   	021552			; Балка и CAUTION
007556: CALL   	020072
007562: CALL   	005752			; Выводим человечка в падении
007566: CALL   	022462			; Рисуем тамбур-переход для фазы в вагоне
007572: CALL   	024774
007576: CALL   	022712			; Скроллинг насыпи под поездом
007602: CALL   	021520
007606: CALL   	022202			; Появление и движение балки
007612: CALL   	020526			; Звук
007616: TSTB   	@#100030
007622: BNE    	007630
007624: CALL   	025574
007630: TSTB   	@#100035
007634: BEQ    	007642
007636: CALL   	034226			; клавиатура
007642: MOV    	(SP)+, R1
007644: TSTB   	@#100035
007650: BEQ    	007662
007652: TSTB   	R0			; нажата клавиша?
007654: BEQ    	007662
007656: JMP    	001774
007662: SOB    	R1, 007524
007664: DECB   	@#100010
007670: BEQ    	007676
007672: JMP    	003352
007676: JMP    	007720

007702:					; ???

; Нет больше жизней
007720: CALL   	025570			; RETURN
007724: TSTB   	@#100035		; демо-режим?
007730: BEQ    	007736			; нет => переходим
007732: JMP    	001774			; на начало игрового цикла
; Реальная игра, кончились жизни
007736: CLR    	R1
007740: MOV    	R1, -(SP)
007742: CALL   	033454
007746: CALL   	022322
007752: CALL   	024466
007756: CALL   	020724			; Скроллирующийся фон
007762: CALL   	021552
007766: CALL   	005752			; Выводим человечка в падении
007772: CALL   	022050
007776: CALL   	022462			; Рисуем тамбур-переход для фазы в вагоне
010002: MOV    	#101261, R1
010006: MOV    	#025172, R3
010012: CALL   	034366
010016: CALL   	034226			; клавиатура
010022: MOV    	(SP)+, R1
010024: TSTB   	R0			; нажата клавиша?
010026: BEQ    	010034
010030: JMP    	002316
010034: DECB   	R1
010036: BNE    	007740
010040: JMP    	001662
;
; Подпрограмма: Опускание человечка на верёвке
; возвращает C=1 если было нажатие
010044: CALL	025570			; RETURN
010050: MOV	#010452, R3
010054: CALL	025572			; RETURN
010060: MOVB	#000353, @#100042	; Положение человечка Y = -21
010066: TSTB	@#100035		; демо-режим?
010072: BEQ	010106			; нет => переходим
010074: CALL	034226			; Клавиатура
010100: SEC				; устанавливаем C -- "есть нажатие"
010102: BEQ	010106			; нет нажатой клавиши => переходим
010104: RETURN				; выходим с флагом C=1
010106: CALL	033454			; Формирование реального экрана по образу
010112: CALL	025454			; Увеличить счётчики
010116: CALL	022322			; Скопировать блок тайлов поезда на экран план
010122: CALL	024466			; Вывод индикаторной строки вверху экрана
010126: CALL	010416			; Печать строки STAGE 1  READY
010132: CALL	024774			; Если демо, то GAME OVER
010136: CALL	022712			; Скроллинг насыпи под поездом
010142: CALL	020724			; Скроллирующийся фон
010146: CALL	021520			; Обработка счётчика скроллируемого фона
010152: CALL	011400
010156: MOVB	@#100042, R0		; Положение человечка Y
010162: ADD	#000003, R0		; на три строки ниже
010166: MOVB	R0, @#100174
010172: CALL	010354
010176: TSTB	@#100016
010202: BNE	010066
010204: MOVB	@#100042, R0		; Положение человечка Y
010210: CMPB	R0, #000007		; уже на крыше поезда?
010214: BEQ	010226			; да => переходим
010216: INCB	R0			; на строку ниже
010220: MOVB	R0, @#100042		; Сохраняем Положение человечка Y
010224: BR	010066
010226: TSTB	@#100035		; демо-режим?
010232: BEQ	010246			; нет => переходим
010234: CALL   	034226			; Клавиатура
010240: SEC    				; устанавливаем C -- "есть нажатие"
010242: BEQ    	010246			; нет нажатия => переходим
010244: RETURN 				; возврат с флагом C=1
010246: CALL	033454			; Формирование реального экрана по образу
010252: CALL	025454
010256: CALL	022322			; Скопировать блок тайлов поезда на экран план
010262: CALL	024466			; Вывод индикаторной строки вверху экрана
010266: CALL	010416			; Печать строки STAGE 1  READY
010272: CALL	024774			; Если демо, то GAME OVER
010276: CALL	022712			; Скроллинг насыпи под поездом
010302: CALL	020724			; Скроллирующийся фон
010306: CALL	021520			; Обработка счётчика скроллируемого фона
010312: CALL	011400
010316: CALL	010354
010322: TSTB	@#100016
010326: BNE	010226
010330: MOVB	@#100174, R0
010334: BEQ	010346
010336: DECB	R0
010340: MOVB	R0, @#100174
010344: BR	010226
010346: CALL	025570			; RETURN
010352: RETURN	
;
010354: MOV	#101127, R1
010360: MOVB	@#100174, R0
010364: BNE	010370
010366: RETURN	
010370: BPL	010374
010372: RETURN	
010374: MOV	R0, R2
010376: BIC	#177400, R2
010402: MOVB	#000342, (R1)
010406: ADD	#000040, R1
010412: SOB	R2, 010402
010414: RETURN	
; Подпрограмма: Печать строки STAGE 1  READY
010416: MOV	#010432, R3		; Адрес строки STAGE 1  READY
010422: MOV	#101317, R1		; Адрес в экране план
010426: JMP	034366			; Печать строки
;
010432: DB	"STAGE 1  READY!", 000

010452: DB

010470: CALL   	025570
010474: MOVB   	#000036, @#100041
010502: CLR    	R0
010504: MOVB   	R0, @#100051
010510: DECB   	R0
010512: MOVB   	R0, @#100050
010516: TSTB   	@#100035
010522: BEQ    	010540
010524: CALL   	034226			; клавиатура
010530: TSTB   	R0			; было нажатие?
010532: SEC    				; ставим C=1
010534: BEQ    	010540			; нет нажатия => переходим
010536: RETURN 				; выходим с флагом C=1
010540: CALL   	033454
010544: CALL   	025454			; Увеличить счётчики
010550: CALL   	022322
010554: CALL   	024466
010560: CALL   	020724			; Скроллирующийся фон
010564: CALL   	021552			; Балка и CAUTION
010570: CALL   	020526			; Звук
010574: CALL   	011400
010600: CALL   	022462			; Рисуем тамбур-переход для фазы в вагоне
010604: CALL   	010770
010610: CALL   	024774
010614: CALL   	022712
010620: CALL   	021520
010624: CALL   	022202			; Появление и движение балки
010630: TSTB   	@#100016
010634: BNE    	010516
010636: CALL   	013224
010642: DECB   	@#100041
010646: CMPB   	@#100041, #000017
010654: BNE    	010516
010656: CLRB   	@#100043
010662: MOV    	#000100, R1
010666: MOV    	R1, -(SP)
010670: CALL   	033454
010674: CALL   	025454			; Увеличить счётчики
010700: CALL   	022322
010704: CALL   	024466
010710: CALL   	020724			; Скроллирующийся фон
010714: CALL   	021552			; Балка и CAUTION
010720: CALL   	020526			; Звук
010724: CALL   	011400
010730: CALL   	022462			; Рисуем тамбур-переход для фазы в вагоне
010734: CALL   	010770
010740: CALL   	024774
010744: CALL   	022712
010750: CALL   	021520
010754: CALL   	022202			; Появление и движение балки
010760: MOV    	(SP)+, R1
010762: SOB    	R1, 010666
010764: TSTB   	R0
010766: RETURN 	
;
010770: MOV    	#011000, R3
010774: JMP    	010422
;
011000: DB      "STAGE 2  READY!", 000

011020: TSTB   	@#100035
011024: BEQ    	011030
011026: RETURN 	
011030: MOVB   	@#100004, @#100172	; Оставшееся время
011036: CALL   	025454			; Увеличить счётчики
011042: CALL   	022322
011046: CALL   	024466
011052: CALL   	020724			; Скроллирующийся фон
011056: CALL   	021552			; Балка и CAUTION
011062: CALL   	022050			; Вывод балки на экран
011066: CALL   	011142
011072: CALL   	024774
011076: CALL   	033454
011102: MOV    	#000062, R2
011106: MOV    	#000012, R1
011112: CALL   	034300
011116: TSTB   	@#100004		; Время закончилось?
011122: BNE    	011130
011124: JMP    	025570
011130: DECB   	@#100004		; Уменьшаем оставшееся время
011134: INC    	@#100000
011140: BR     	011036
;
011142: MOV    	#101312, R1
011146: MOV    	#011206, R3
011152: CALL   	034366
011156: MOV    	#101320, R1
011162: MOVB   	@#100172, R0
011166: CALL   	034476
011172: MOV    	#101327, R1
011176: MOVB   	@#100172, R0
011202: JMP    	034476
;
011206:

011256: MOV    	#011272, R3
011262: MOV    	#101315, R1
011266: JMP    	034366
;
011272: DB      "STAGE 1  COMPLETE!", 000

011324: DB      "STAGE 2  COMPLETE!", 000

011350: MOV    	#101706, R1
011354: MOV    	#000150, R0
011360: MOV    	#000003, R2
011364: MOVB   	R0, (R1)+
011366: MOVB   	R0, (R1)
011370: ADD    	#000037, R1
011374: SOB    	R2, 011364
011376: RETURN 	

; Подпрограмма
011400: MOVB	@#100041, 034564	; Положение человечка X сохраняем
011406: MOVB	@#100042, 034565	; Положение человечка Y сохраняем
011414: CALL	033362			; Получаем в R1 адрес в образе экрана
011420: TSTB	@#100044
011424: BNE	011576
011426: MOV	#011626, R3		; Спрайт голова человечка, смотрит влево
011432: TSTB	@#100042
011436: BPL	011534
011440: CLRB	034565			; Y = 0
011444: MOVB	@#100041, 034564	; Положение человечка X сохраняем
011452: CALL	033362			; Получаем в R1 адрес в образе экрана
011456: MOVB	@#100042, R0		; Положение человечка Y
011462: NEGB	R0
011464: BIC	#177400, R0
011470: CMPB	R0, #000002
011474: BHIS	011514
011476: ASLB	R0
011500: ASLB	R0
011502: ADD	R0, R3
011504: CALL	025402			; Вывод спрайта
011510: JMP	025402			; Вывод спрайта
011514: CMPB	R0, #000003
011520: BLO	011524
011522: RETURN	
011524: MOV	#011637, R3		; Спрайт тело человечка, смотрит влево
011530: JMP	025402			; Вывод спрайта
011534: MOVB	@#100051, @#101103
011542: CALL	025402			; Вывод спрайта
011546: MOVB	@#100051, @#101103
011554: TSTB	@#100043
011560: BNE	011566
011562: JMP	025402			; Вывод спрайта
011566: MOV    	#011644, R3
011572: JMP    	025402			; Вывод спрайта
011576: MOV    	#011651, R3		; Спрайт лежащего человечка, головой влево
011602: MOVB   	@#100051, R0
011606: ASLB   	R0
011610: ASLB   	R0
011612: ASLB   	R0
011614: ASLB   	R0
011616: MOVB   	R0, @#101103
011622: JMP    	025402			; Вывод спрайта
; Спрайт голова человечка, смотрит влево
011626:	.BYTE	200,001,201,037,220,001,221,037,000
; Спрайт тело человечка, смотрит влево
011637:	.BYTE	240,001,241,000,000
; Спрайт ноги человечка в прыжке
011644:	.BYTE	260,001,261,000,000
; Спрайт лежащего человечка, головой влево
011651:	.BYTE	204,001,205,001,206,001,207,035,224,001,225,001,226
	.BYTE	001,227,000,000
;
011672: TSTB	@#100045
011676: BEQ	011704
011700: JMP    	013276
011704: TSTB	@#100047
011710: BEQ	011716
011712: JMP    	013140
011716: TSTB	@#100036
011722: BNE	011746
011724: MOVB	#000017, @#100041	; Положение человечка = 15.
011732: MOV	#000007, R0		; Y = 7 -- на крыше
011736: MOVB	@#100006, R4		; фаза игры
011742: DECB	R4
011744: BEQ	011764			; на крыше => переходим
011746: MOV    	#000020, R0		; Y = 16. -- в вагоне
011752: TSTB   	@#100046
011756: BEQ    	011764
011760: MOV    	#000014, R0		; Y = 12. -- в вагоне на поручнях
011764: MOVB	R0, @#100042		; Сохраняем Положение человечка Y
011770: TSTB	@#100035		; демо-режим?
011774: BEQ	012056			; нет => читаем клавиатуру
011776: MOVB   	@#100011, 034570	; Берём адрес демо-последовательности
012004: MOVB   	@#100012, 034571	; /
012012: MOV    	034570, R3		; передаём его в R3
012016: MOVB   	(R3)+, R0		; следующий байт
012020: MOV    	R3, 034570		;
012024: MOVB   	034570, @#100011	; сохраняем увеличенный адрес
012032: MOVB   	034571, @#100012	; /
012040: SUB    	#134377, R3		; дошли до конца?
012044: BLO    	012224			; нет => переходим
012046: MOVB   	#000377, @#100035	; ставим признак что дошли до конца демо
012054: RETURN 	
012056: TSTB	034224			; признак нажатой клавиши
012062: BEQ	012120			; нет нажатия => переходим
012064: MOV	@#177542, R1		; Читаем порт B от клавиатуры 7007
012070: COM	R1
012072: ASL	R1
012074: ASL	R1
012076: ASL	R1
012100: BIC	#177577, R1
012104: MOV	R1, -(SP)
012106: CALL	033734			; Получить символ от клавиатуры 7007
012112: MOV	(SP)+, R1
012114: BISB	R1, R0
012116: BR	012134
012120: CALL   	001404			; Получаем нажатую клавишу в R0 если она есть
012124: CMPB   	#000113, R0		; 'K' ?
012130: BNE    	012134			; нет => переходим
; Нажата 'K'
012132: CLR    	R0
012134: MOVB	@#100011, 034570
012142: MOVB	@#100012, 034571
012150: MOV	034570, R3
012154: SUB	#134377, R3
012160: BHIS	012224
012162: MOVB	@#100011, 034570
012170: MOVB	@#100012, 034571
012176: MOV	034570, R3
012202: MOVB	R0, (R3)+
012204: MOV	R3, 034570
012210: MOVB	034570, @#100011
012216: MOVB	034571, @#100012
012224: MOV	R0, -(SP)		; сохраняем R0
012226: BIT	#000200, R0
012232: BEQ	012240
012234: CALL	013556			; Выпустить змея
012240: MOV	(SP)+, R0		; восстанавливаем R0
012242: BIC	#177600, R0		; оставляем младшие 7 бит -- 0..128.
012246: SUB	#000061, R0		; минус '1'
012252: BIC	#177400, R0		; оставляем младший байт
012256: BEQ	012364			; '1'
012260: DECB	R0			;
012262: BEQ	012400			; '2'
012264: DECB	R0			;
012266: BEQ	012406			; '3'
012270: CLRB	@#100044
012274: DECB	R0			;
012276: BEQ	012340			; '4'
012300: SUB	#000002, R0		;
012304: BIC	#177400, R0		;
012310: BEQ	012344			; '6'
012312: DECB	R0			;
012314: BEQ	012350			; '7'
012316: DECB	R0			;
012320: BEQ	012354			; '8'
012322: DECB	R0			;
012324: BEQ	012360			; '9'
012326: CLRB	@#100043
012332: CLRB	@#100050		; DX = 0
012336: RETURN	
012340: JMP    	012542			; нажата 4 -- влево
012344: JMP    	012572			; нажата 6 -- вправо
012350: JMP    	012620			; нажата 7
012354: JMP    	012636			; нажата 8
012360: JMP    	012646			; нажата 9
; Нажата '1' -- влево-вниз
012364: CLRB   	@#100051
012370: MOVB   	#000377, @#100050	; DX = -1 -- влево
012376: BR     	012422
; Нажата '2' -- вниз
012400: CLRB   	@#100050		; DX = 0
012404: BR     	012422
; Нажата '3' -- вправо-вниз
012406: MOVB   	#000001, @#100050	; DX = 1 -- вправо
012414: MOVB   	#000002, @#100051
; Была нажата '1'/'2'/'3' -- вниз
012422: TSTB   	@#100046
012426: BNE    	012524
012430: CLRB   	@#100050		; DX = 0
012434: TSTB   	@#100036
012440: BNE    	012522
012442: TSTB   	@#100044
012446: BNE    	012470
012450: MOVB   	@#100051, R1
012454: DECB   	R1
012456: MOVB   	@#100041, R0		; Положение человечка
012462: ADD    	R1, R0
012464: MOVB   	R0, @#100041		; Сохраняем новое положение человечка
012470: MOVB   	#000001, @#100044
012476: MOVB   	@#100006, R4		; фаза игры
012502: MOV    	#000010, R0		; Y = 8.
012506: DECB   	R4
012510: BEQ    	012516			; на крыше => переходим
012512: MOV    	#000021, R0		; Y = 17.
012516: MOVB   	R0, @#100042		; Сохраняем Положение человечка Y
012522: RETURN 	
012524: CLRB   	@#100046
012530: MOVB   	#000001, @#100047
012536: JMP    	013140
; Нажата '4' -- влево
012542: CLRB   	@#100051
012546: MOVB   	#000377, @#100050	; DX = -1 -- влево
012554: TSTB   	@#100046
012560: BEQ    	012566
012562: JMP    	012524
012566: JMP    	012766
; Нажата '6' -- вправо
012572: MOVB   	#000001, @#100050	; DX = 1 -- вправо
012600: MOVB   	#000002, @#100051
012606: TSTB   	@#100046
012612: BNE    	012524
012614: JMP    	013056
; Нажата '7' -- влево-вверх
012620: CLRB   	@#100051
012624: MOVB   	#000377, @#100050	; DX = -1 -- влево
012632: JMP    	012662
; Нажата '8' -- вверх
012636: CLRB   	@#100050		; DX = 0
012642: JMP    	012662
; Нажата '9' -- вправо-вверх
012646: MOVB   	#000001, @#100050
012654: MOVB   	#000002, @#100051
; Была нажата '7'/'8'/'9' -- вверх
012662: TSTB   	@#100046
012666: BEQ    	012672
012670: RETURN 	
012672: MOVB   	#000001, @#100045
012700: MOVB   	#000001, @#100055
012706: MOVB   	#000337, @#100056
012714: MOVB   	#000040, @#100057
012722: MOVB   	#000017, @#100060
012730: MOVB   	#000012, @#100043
012736: MOV    	#013510, R3		; ???
012742: MOVB   	@#100006, R0		; фаза игры
012746: DECB   	R0
012750: BEQ    	012756			; на крыше => переходим
012752: MOV    	#013527, R3		; ???
012756: MOV    	R3, @#100052
012762: JMP    	013276
012766: TSTB   	@#100016
012772: BNE    	012670
012774: MOVB   	#000377, @#100050	; DX = -1 -- влево
013002: TSTB   	@#100036
013006: BEQ    	013046
013010: MOVB   	@#100041, R0		; Положение человечка X
013014: CMPB   	R0, #000003
013020: BHIS   	013034
013022: MOVB   	#000003, @#100041
013030: JMP    	013224
013034: DECB   	R0
013036: MOVB   	R0, @#100041		; Положение человечка X
013042: JMP    	013224
013046: CALL   	020134
013052: JMP    	013224
013056: TSTB   	@#100016
013062: BNE    	012670
013064: MOVB   	#000001, @#100050	; DX = 1 -- вправо
013072: TSTB   	@#100036
013076: BEQ    	013132
013100: MOVB   	@#100041, R0		; Положение человечка X
013104: CMPB   	R0, #000035
013110: BLO    	013122
013112: MOVB   	#000035, @#100041
013120: BR     	013224
013122: INCB   	R0
013124: MOVB   	R0, @#100041		; Положение человечка X
013130: BR     	013224
013132: CALL   	020322			; Скроллирование поезда влево
013136: BR     	013224
;
013140: TSTB   	@#100016
013144: BEQ    	013150
013146: RETURN 	
013150: MOVB   	@#100042, R0		; Положение человечка Y
013154: CMPB   	R0, #000020		; = 16. ?
013160: BEQ    	013212			; да => переходим
013162: INCB   	R0			; на 1 ниже
013164: MOVB   	R0, @#100042		; Сохраняем Положение человечка Y
013170: MOVB   	@#100050, R0		; берём DX
013174: BEQ    	013146			; DX = 0 => переходим
013176: INCB   	R0			;
013200: BNE    	013206			; DX <> -1 => переходим
013202: JMP    	012766			; DX = -1, переходим
013206: JMP    	013056			; DX = 1, переходим
013212: CLRB   	@#100047
013216: CLRB   	@#100043
013222: RETURN 	
; Подпрограмма
013224: TSTB   	@#100050		; DX = 0 ?
013230: BEQ    	013266			; да => переходим
013232: TSTB   	@#100045
013236: BNE    	013266
013240: TSTB   	@#100047
013244: BNE    	013266
013246: MOVB   	@#100043, R0
013252: MOV    	#000020, R4
013256: XOR    	R4, R0
013260: MOVB   	R0, @#100043
013264: RETURN 	
013266: MOVB   	#000020, @#100043
013274: RETURN 	
; Подпрограмма; (100052) -- адрес посл-ти, кончается на 210
013276: MOVB   	@#100006, R0		; фаза игры
013302: DECB   	R0
013304: BEQ    	013416			; на крыше => переходим
013306: CMPB   	@#100042, #000014	; Положение человечка Y = 12. ?
013314: BNE    	013416
013316: MOV    	#000372, R2
013322: MOV    	#100402, R3
013326: MOVB   	@#100041, R1		; Положение человечка X
013332: DECB   	R1
013334: BIC    	#177400, R1
013340: ADD    	R1, R3
013342: MOVB   	(R3), R0
013344: SUB    	R2, R0
013346: BIC    	#177400, R0
013352: BNE    	013416
013354: INC    	R3
013356: INC    	R3
013360: INC    	R3
013362: MOVB   	(R3), R0
013364: SUB    	R2, R0
013366: BIC    	#177400, R0
013372: BNE    	013416
013374: MOVB   	R0, @#100045
013400: INCB   	R0
013402: MOVB   	R0, @#100046
013406: MOVB   	#000014, @#100042	; Положение человечка Y = 12.
013414: RETURN 	
013416: MOV    	@#100052, R3
013422: MOVB   	(R3)+, R4
013424: MOVB	@#100042, R0		; Положение человечка Y
013430: ADD    	R4, R0
013432: MOVB	R0, @#100042		; Сохраняем Положение человечка Y
013436: MOV    	R3, @#100052
013442: MOVB   	(R3), R0
013444: SUB    	#000210, R0
013450: BIC    	#177400, R0
013454: BNE    	013466			; <> 210 => переходим
013456: MOVB   	R0, @#100045
013462: MOVB   	R0, @#100043
013466: MOVB   	@#100050, R0		; DX = 0 ?
013472: BEQ    	013414			;   да => переходим
013474: INCB   	R0			; DX = -1 ?
013476: BEQ    	013504			;   да => переходим
013500: JMP    	013056			; DX = 1, переходим
013504: JMP    	012766			; DX = -1, переходим

; Подпрограмма: Выпустить змея
013556: CLRB	@#100044
013562: TSTB	@#100054
013566: BEQ	013672
013570: CMPB   	@#100042, #000007	; Положение человечка Y = 7 ?
013576: BNE    	013672			; нет => выходим
013600: TSTB   	@#100065
013604: BEQ    	013616
013606: CMPB   	@#100063, #000040	; позиция змея меньше длины строки?
013614: BLO    	013672			; меньше => выходим
013616: CLR    	R0
013620: MOVB   	R0, @#100054
013624: INCB   	R0
013626: MOVB   	R0, @#100065
013632: MOVB   	R0, @#100071
013636: MOVB   	#000050, @#100066
013644: CLRB   	@#100067
013650: MOVB   	#000021, @#100063	; позиция X змея
013656: MOVB   	#000010, @#100064
013664: MOVB   	#000360, @#100072	; = 240.
013672: RETURN	
;
013674: TSTB	@#100035		; демо-режим?
013700: BNE	013672			; да => выходим
013702: TSTB	@#100055
013706: BEQ	013672			; =0 ? => выходим
013710: MOVB   	@#100060, R0
013714: INCB   	R0
013716: BNE    	013726
013720: CLRB   	@#100055
013724: RETURN 	
013726: MOVB   	@#100057, R1
013732: BIC    	#177400, R1
013736: BIT    	#000200, R1
013742: BNE    	013772
013744: MOVB   	@#100056, R0
013750: BIC    	#177400, R0
013754: ADD    	R1, R0
013756: BIT    	#000400, R0
013762: BNE    	014014
013764: MOVB   	R0, @#100056
013770: BR     	014020
013772: MOVB   	@#100056, R0
013776: ADD    	R1, R0
014000: CMPB   	R0, #000337
014004: BLO    	014014
014006: MOVB   	R0, @#100056
014012: BR     	014020
014014: NEGB   	@#100057
014020: TSTB   	@#100016
014024: BNE    	014032
014026: DECB   	@#100060
014032: RETURN	
;
014034: TSTB	@#100065
014040: BEQ	014032
014042: MOVB   	@#100063, R0		; позиция змея
014046: CMPB   	R0, #000036
014052: BHIS   	014032
014054: MOVB   	R0, 034564		; X
014060: MOVB   	@#100064, 034565	; Y
014066: CALL   	033362			; Получаем в R1 адрес в образе экрана
014072: MOV    	#014126, R3		; Спрайт змея, смотрит вправо
014076: MOVB   	@#100067, R0
014102: CMPB   	R0, #000003
014106: BLO    	014114
014110: MOV    	#000001, R0
014114: ASL    	R0
014116: MOVB   	R0, @#101103
014122: JMP    	025402			; Вывод спрайта
; Спрайт змея, смотрит вправо
014126: .BYTE	312,001,313,037,332,001,333,000,000,000
;
014140: MOVB	@#100065, R0
014144: BEQ	014264
014146: DECB   	R0
014150: BNE    	014274
014152: MOVB   	@#100063, R0		; позиция змея
014156: BIC    	#177400, R0
014162: CMPB   	R0, #000040
014166: BLO    	014176
014170: SUB    	#000040, R0
014174: BR     	014156
014176: BIC    	#177400, R0
014202: MOV    	#100202, R3		; Адрес блока тайлов поезда
014206: ADD    	R0, R3
014210: CMPB   	(R3), #000040
014214: BNE    	014224
014216: MOVB   	#000002, @#100065
014224: MOV    	#100067, R3
014230: TSTB   	@#100016
014234: BNE    	014242
014236: CALL   	025554
014242: TSTB   	@#100022		; Быстрый счётчик = 0 ?
014246: BNE    	014264			; нет => переходим
014250: DECB   	@#100066
014254: BNE    	014266
014256: MOVB   	#000002, @#100065
014264: RETURN	
014266: INCB   	@#100063		; позиция змея
014272: RETURN 	
014274: MOVB   	@#100064, R0
014300: CMPB   	R0, #000026
014304: BLO    	014320
014306: CLRB   	@#100065
014312: CLRB   	@#100075
014316: RETURN 	
014320: INCB   	R0
014322: MOVB   	R0, @#100064
014326: RETURN 	
; Подпрограмма
014330: TSTB	@#100035		; демо-режим?
014334: BNE	014416			; да => RETURN
014336: TSTB	@#100071
014342: BEQ	014416			; 0? => RETURN
014344: MOVB   	@#100072, R2
014350: BIC    	#177400, R2		; оставляем младший байт
014354: MOV    	#000005, R1
014360: CALL   	034300			; Звук
014364: MOVB   	@#100072, R0
014370: BIC    	#177400, R0
014374: SUB    	#000036, R0		; R0 = R0 - 30.
014400: MOVB   	R0, @#100072
014404: BIT    	#177400, R0
014410: BEQ    	014416			; 0? => RETURN
014412: CLRB   	@#100071
014416: RETURN	
; Подпрограмма
014420: TSTB	@#100074
014424: BEQ	014416			; 0? => RETURN
014426: MOVB	@#100073, R0
014432: CMPB	R0, #000036
014436: BHIS	014416			; ? => RETURN
014440: MOVB	R0, 034564		; X
014444: MOVB	#000005, 034565		; Y = 5
014452: CALL	033362			; Получаем в R1 адрес в образе экрана
014456: MOV	#014126, R3		; Спрайт змея, смотрит вправо
014462: MOVB	@#100076, R0
014466: CMPB	R0, #000003
014472: BLO	014500
014474: MOV	#000001, R0
014500: ASL	R0
014502: ADD	#000040, R0
014506: MOVB	R0, @#101103
014512: JMP	025402			; Вывод спрайта
; Подпрограмма
014516: TSTB	@#100074
014522: BEQ	014622
014524: MOV	#100076, R3
014530: TSTB	@#100016
014534: BNE	014542
014536: CALL	025554
014542: MOVB	@#100050, R0		; берём DX
014546: BEQ	014570			; DX = 0? => переходим
014550: DECB   	R0
014552: BEQ    	014562
014554: MOVB   	@#100015, R0
014560: BR     	014574
014562: MOVB   	@#100020, R0
014566: BR     	014574
014570: MOVB	@#100016, R0
014574: TSTB	R0
014576: BNE	014620
014600: INCB	@#100073
014604: CMPB	@#100073, #000100
014612: BLO	014620
014614: CLR    	@#100074
014620: RETURN	
014622: MOVB	@#100075, R0
014626: SUB	#000002, R0
014632: MOVB	R0, @#100075
014636: TSTB	R0
014640: BMI	014662
014642: MOVB	@#100065, R0
014646: BNE	014662
014650: MOVB	R0, @#100073
014654: INC	R0
014656: MOVB	R0, @#100074
014662: RETURN	
; Подпрограмма: 
014664: TSTB	@#100036
014670: BNE	014704
014672: MOV	#100100, R5		; Адрес 4-х записей объектов
014676: MOVB	(R5), R0
014700: INCB	R0
014702: BNE	014706
014704: RETURN	
014706: TSTB	000005(R5)
014712: BEQ	014756
014714: MOVB	000006(R5), R0
014720: CMPB	R0, #000040
014724: BHIS	014756
014726: MOVB	R0, 034564		; X
014732: MOVB	000007(R5), 034565	; Y
014740: CALL	033362			; Получаем в R1 адрес в образе экрана
014744: MOVB	@#100006, R0		; фаза игры
014750: ADD	#000347, R0
014754: MOVB	R0, (R1)
014756: TSTB	(R5)
014760: BNE	014770
014762: ADD	#000010, R5
014766: BR	014676
014770: MOVB	000002(R5), R0
014774: CMPB	R0, #000036
015000: BHIS	014762
015002: MOVB	R0, 034564		; X
015006: MOVB	000003(R5), 034565	; Y
015014: CALL	033362			; Получаем в R1 адрес в образе экрана
015020: MOVB	000004(R5), R0
015024: CMPB	R0, #000010
015030: BEQ	015234
015032: MOV	#015250, R3
015036: MOVB	000004(R5), R0
015042: BIC	#177400, R0
015046: MOV	R0, R2
015050: ASL	R2
015052: ADD	R0, R2
015054: ASL	R2
015056: ADD	R2, R3
015060: MOVB	000001(R5), R4
015064: BIC	#177400, R4
015070: MOV	#000037, R2
015074: MOVB	(R5), R0
015076: DECB	R0
015100: BEQ	015106
015102: MOV	#000003, R4
015106: MOVB	(R3)+, (R1)+
015110: MOVB	(R3)+, (R1)
015112: ADD	R2, R1
015114: SOB	R4, 015106
015116: CMPB	(R5), #000003
015122: BNE	014762
015124: CMPB	000001(R5), #000004
015132: BHIS	014762
015134: MOVB	000002(R5), 034564
015142: MOVB	@#100006, R0		; фаза игры
015146: DECB	R0
015150: BNE	015172			; в вагоне => переходим
015152: INCB	034564			; X++
015156: INCB	034564			; X++
015162: MOVB	#000010, 034565		; Y = 8.
015170: BR	015204
015172: DECB   	034564			; X--
015176: MOVB   	#000021, 034565		; Y = 17.
015204: CALL	033362			; Получаем в R1 адрес в образе экрана
015210: MOVB	@#100006, R0		; фаза игры
015214: BIC	#177400, R0
015220: SUB	#000352, R0
015224: NEGB	R0
015226: MOVB	R0, (R1)
015230: JMP	014762
015234: MOV    	#015330, R3		; Спрайт падающий враг
015240: CALL   	025402			; Вывод спрайта
015244: JMP    	014762
;
015250:	.BYTE	216,217,210,211,230,231, 216,217,212,213,232,233
	.BYTE	216,217,214,215,234,235, 216,217,212,213,232,233
	.BYTE	216,217,250,251,270,271, 216,217,252,253,272,273
	.BYTE	254,255,274,275,236,237, 256,257,276,277,236,237
; Спрайт падающий враг
015330:	.BYTE	254,001,255,001,256,036,274,001,275,001,276,000,000,000
;
; Подпрограмма: что-то с объектами
015346: TSTB	@#100036
015352: BNE	015470			; не ноль => выходим
015354: CLRB	@#100141
015360: MOV	#100100, R5		; Адрес 4-х записей объектов
015364: MOVB	(R5), R0
015366: CMPB	R0, #000377
015372: BEQ	015414
015374: DECB	R0
015376: BEQ	015406
015400: ADD	#000010, R5		; К следующей записи
015404: BR	015364			; повторяем
015406: MOVB	#000001, @#100141
015414: MOV	#100100, R5		; Адрес 4-х записей объектов
015420: MOVB	(R5), R0
015422: INCB	R0
015424: BEQ	015470
015426: TSTB	000005(R5)
015432: BEQ	015512
015434: MOVB	@#100006, R0		; фаза игры
015440: DECB	R0
015442: BNE	015472
015444: DECB	000006(R5)
015450: MOVB	000006(R5), R0
015454: CMPB	R0, #000370
015460: BLO	015512
015462: CLRB   	000005(R5)
015466: BR     	015512
015470: RETURN	
015472: INCB   	000006(R5)
015476: CMPB   	000006(R5), #000100
015504: BLO    	015512
015506: CLRB   	000005(R5)
015512: TSTB	@#100016
015516: BNE	015572
015520: MOVB	(R5), R0
015522: DECB	R0
015524: BEQ	015546
015526: DECB	R0
015530: BEQ	015552
015532: DECB	R0
015534: BEQ	015556
015536: DECB	R0
015540: BEQ	015562
015542: JMP	015602
015546: JMP	016040
015552: JMP	016212
015556: JMP	016444
015562: JMP    	016614
015566: JMP    	016720
015572: ADD	#000010, R5
015576: JMP	015420
015602: TSTB	@#100034
015606: BNE	015572
015610: DECB	000001(R5)
015614: BNE	015572
015616: TSTB	@#100141
015622: BNE	015566
015624: MOVB	@#100006, R0		; фаза игры
015630: DECB	R0
015632: BNE	015760
015634: TSTB	@#100155		; номер вагона
015640: BEQ	015566			; вагон 000 => переходим
015642: MOV	#100202, R3		; Адрес блока тайлов поезда
015646: MOV	#000040, R1		; 32.
015652: MOV	#000040, R0		; пустой тайл
015656: CMPB	R0, (R3)+
015660: BEQ	015666
015662: SOB    	R1, 015656
015664: BR     	015670
015666: DEC	R1
015670: MOV	#000037, R0
015674: SUB	R1, R0
015676: CMPB	R0, #000021
015702: BHIS	015716
015704: ADD	#000040, R0
015710: BIC	#177400, R0
015714: BR	015676
015716: MOVB	#000001, (R5)
015722: MOVB	#000001, 000001(R5)
015730: MOVB	R0, 000002(R5)
015734: MOVB	#000013, 000003(R5)
015742: CLRB	000004(R5)
015746: MOVB	#000001, @#100141
015754: JMP	015572
015760: MOVB   	#000002, (R5)
015764: MOV    	#000012, R0
015770: MOVB   	@#100007, R4		; Stage
015774: DECB   	R4
015776: BEQ    	016004
016000: MOV    	#000005, R0
016004: MOVB   	R0, 000001(R5)
016010: CLRB   	000002(R5)
016014: MOVB   	#000020, 000003(R5)
016022: MOVB   	#000001, 000004(R5)
016030: JMP    	015572
016034: JMP    	016720
016040: MOVB	@#100006, R0		; фаза игры
016044: DECB	R0
016046: BNE	016034			; в вагоне => переходим
016050: MOVB	#000001, @#100141
016056: CMPB	000002(R5), #000100
016064: BHIS	016034
016066: CMPB	000001(R5), #000003
016074: BEQ	016112
016076: DECB	000003(R5)
016102: INCB	000001(R5)
016106: JMP	015572
016112: CMPB	000003(R5), #000006
016120: BEQ	016132
016122: DECB	000003(R5)
016126: JMP	015572
016132: MOVB	#000002, (R5)
016136: MOV	#000012, R0
016142: MOVB	@#100007, R4		; Stage
016146: DECB	R4
016150: BEQ	016156
016152: MOV    	#000005, R0
016156: MOVB	R0, 000001(R5)
016162: DECB	000002(R5)
016166: DECB	000002(R5)
016172: MOVB	#000007, 000003(R5)
016200: MOVB	#000001, 000004(R5)
016206: JMP	015572
016212: MOVB	@#100006, R0		; фаза игры
016216: DECB	R0
016220: BNE	016350
016222: CMPB	000002(R5), #000017
016230: BLO	016206
016232: CMPB	000002(R5), #000100
016240: BLO	016246
016242: JMP	016720
016246: TSTB	@#100034
016252: BNE	016206
016254: DECB	000001(R5)
016260: BNE	016304
016262: MOVB	#000003, (R5)
016266: CLRB	000001(R5)
016272: MOVB	#000005, 000004(R5)
016300: JMP	015572
016304: INCB	000004(R5)
016310: CMPB	000004(R5), #000004
016316: BLO	016324
016320: CLRB	000004(R5)
016324: DECB	000002(R5)
016330: CMPB	000002(R5), #000036
016336: BLO	016344
016340: DECB   	000002(R5)
016344: JMP	015572
016350: CMPB   	000002(R5), #000100
016356: BHIS   	016242
016360: DECB   	000001(R5)
016364: BNE    	016410
016366: MOVB   	#000003, (R5)
016372: CLRB   	000001(R5)
016376: MOVB   	#000005, 000004(R5)
016404: JMP    	015572
016410: INCB   	000004(R5)
016414: CMPB   	000004(R5), #000004
016422: BLO    	016430
016424: CLRB   	000004(R5)
016430: INCB   	000002(R5)
016434: JMP    	015572
016440: JMP    	016720
016444: CMPB	000002(R5), #000100
016452: BHIS	016440
016454: INCB	000001(R5)
016460: MOVB	000001(R5), R0
016464: CMPB	R0, #000010
016470: BLO	016510
016472: MOVB	#000002, (R5)
016476: MOVB	#000040, 000001(R5)
016504: JMP	015572
016510: CMPB	R0, #000004
016514: BNE	016504
016516: MOVB	#000004, 000004(R5)
016524: MOVB	#000001, 000005(R5)
016532: MOVB	@#100006, R0		; фаза игры
016536: DECB	R0
016540: BNE	016566
016542: MOV	000002(R5), R0
016546: DECB	R0
016550: MOVB	R0, 000006(R5)
016554: MOVB	#000010, 000007(R5)
016562: JMP	015572
016566: MOVB   	000002(R5), R0
016572: ADD    	#000002, R0
016576: MOVB   	R0, 000006(R5)
016602: MOVB   	#000021, 000007(R5)
016610: JMP    	015572
016614: MOVB   	@#100006, R0		; фаза игры
016620: DECB   	R0
016622: BNE    	016712
016624: INCB   	000002(R5)
016630: INCB   	000003(R5)
016634: MOVB   	000004(R5), R0
016640: SUB    	#000006, R0
016644: BIC    	#177400, R0
016650: MOV    	#000001, R4
016654: XOR    	R4, R0
016656: ADD    	#000006, R0
016662: MOVB   	R0, 000004(R5)
016666: CMPB   	000003(R5), #000026
016674: BLO    	016504
016676: CLRB   	(R5)
016700: MOVB   	#000024, 000001(R5)
016706: JMP    	015572
016712: DECB   	000001(R5)
016716: BNE    	016504
016720: CLRB	(R5)
016722: MOVB	@#100006, R0		; фаза игры
016726: BIC	#177400, R0
016732: CMPB	R0, #000004
016736: BLO	016744
016740: MOV    	#000003, R0
016744: ASL	R0
016746: ASL	R0
016750: ASL	R0
016752: MOVB	R0, 000001(R5)
016756: JMP	015572
; Подпрограмма: Вывод привидения
016762: MOVB   	@#100144, R1
016766: MOVB   	@#100143, R0
016772: ADD    	R1, R0
016774: MOVB   	R0, @#101102
017000: MOVB   	@#100142, 034564	; Положение привидения -> X
017006: MOVB   	#000015, 034565		; Y = 13.
017014: MOV    	#017150, R3
017020: CALL   	017054
017024: INCB   	034564			; X++
017030: CALL   	017054
017034: DECB   	034564			; X--
017040: INCB   	034565			; Y++
017044: CALL   	017054
017050: INCB   	034564
; Подпрограмма
017054: MOV    	034564, -(SP)		; сохраняем X
017060: MOVB   	034564, R0		; X
017064: BIC    	#177400, R0
017070: CMPB   	R0, #000040
017074: BLO    	017120
017076: CMPB   	R0, #000200
017102: BHIS   	017112
017104: SUB    	#000040, R0
017110: BR     	017064
017112: ADD    	#000040, R0
017116: BR     	017064
017120: MOVB   	R0, 034564		; X
017124: CALL   	033362			; Получаем в R1 адрес в образе экрана
017130: MOVB   	@#101102, R0
017134: MOVB   	(R3)+, R4
017136: ADD    	R4, R0
017140: MOVB   	R0, (R1)
017142: MOV    	(SP)+, 034564		; восстанавливаем X
017146: RETURN 	
; Номера тайлов привидения
017150:	.BYTE	314,315,334,335
;
; Подпрограмма
017154: TSTB   	@#100016
017160: BNE    	017200
017162: MOV    	#000002, R4
017166: MOVB   	@#100143, R0
017172: XOR    	R4, R0
017174: MOVB   	R0, @#100143
017200: TSTB   	@#100034
017204: BNE    	017404
017206: MOVB   	@#100007, R1
017212: MOVB   	@#100016, R0
017216: DECB   	R1
017220: BEQ    	017234
017222: MOVB   	@#100015, R0
017226: DECB   	R1
017230: BEQ    	017234
017232: BR     	017240
017234: TSTB   	R0
017236: BNE    	017404
017240: MOVB   	@#100145, 034570
017246: MOVB   	@#100146, 034571
017254: MOV    	034570, R3
017260: TSTB   	@#100144
017264: BNE    	017272
017266: MOVB   	(R3)+, R1
017270: BR     	017276
017272: MOVB   	(R3)+, R1
017274: NEGB   	R1
017276: BIC    	#177400, R1
017302: MOVB   	@#100142, R0
017306: ADD    	R1, R0
017310: MOVB   	R0, @#100142
017314: MOVB   	(R3), R0		; берём очередной байт последовательности
017316: MOV    	R3, 034570		; текущий адрес в последовательности
017322: MOVB   	034570, @#100145
017330: MOVB   	034571, @#100146
017336: CMPB   	R0, #000210		; конец последовательности?
017342: BNE    	017404
017344: MOVB   	@#100144, R0
017350: MOV    	#000040, R4
017354: XOR    	R4, R0
017356: MOVB   	R0, @#100144
017362: MOV    	#017406, 034570		; Адрес начала последовательности
017370: MOVB   	034570, @#100145
017376: MOVB   	034571, @#100146
017404: RETURN 	
;
; Последовательность движений привидения
017406:

017526: TSTB   	@#100036
017532: BEQ    	017634
017534: MOVB   	@#100147, 034564	; X
017542: MOVB   	@#100150, 034565	; Y
017550: CALL   	033362			; Получаем в R1 адрес в образе экрана
017554: MOV    	#017636, R3		; Спрайт змея, смотрит вправо
017560: CALL   	025402			; Вывод спрайта
017564: TSTB   	@#100035
017570: BNE    	017634
017572: MOV    	#000100, R2
017576: MOV    	#000012, R1
017602: MOVB   	@#100153, R0
017606: CMPB   	R0, #000017
017612: BNE    	017620
017614: CALL   	034300
017620: MOVB   	@#100153, R0
017624: BEQ    	017634
017626: DECB   	R0
017630: MOVB   	R0, @#100153
017634: RETURN 	
; Спрайт змея, смотрит вправо
017636: .BYTE	312,001,313,037,332,001,333,000,000,000
; Подпрограмма
017650: TSTB   	@#100036
017654: BEQ    	020034
017656: MOVB   	@#100007, R1
017662: MOVB   	@#100016, R0
017666: DECB   	R1
017670: BEQ    	017676
017672: MOVB   	@#100015, R0
017676: TSTB   	R0
017700: BNE    	020034
017702: MOVB   	@#100151, R1
017706: MOVB   	@#100147, R0
017712: ADD    	R1, R0
017714: BIC    	#177400, R0
017720: MOVB   	R0, @#100147
017724: CMPB   	R0, #000003
017730: BEQ    	017742
017732: CMPB   	R0, #000035
017736: BEQ    	017760
017740: BR     	017776
017742: MOVB   	#000001, @#100151
017750: MOVB   	#000017, @#100153
017756: BR     	017776
017760: MOVB   	#000377, @#100151
017766: MOVB   	#000017, @#100153
017774: BR     	017776
017776: MOVB   	@#100152, R1
020002: MOVB   	@#100150, R0
020006: ADD    	R1, R0
020010: BIC    	#177400, R0
020014: MOVB   	R0, @#100150
020020: CMPB   	R0, #000013
020024: BEQ    	020036
020026: CMPB   	R0, #000021
020032: BEQ    	020054
020034: RETURN 	
020036: MOVB   	#000001, @#100152
020044: MOVB   	#000017, @#100153
020052: RETURN 	
020054: MOVB   	#000377, @#100152
020062: MOVB   	#000017, @#100153
020070: RETURN 	
; Подрограмма
020072: TSTB   	@#100036
020076: BEQ    	020070
020100: TSTB   	@#100037
020104: BNE    	020070
020106: MOV    	#101725, R1		; Адрес в экране план
020112: MOV    	#020122, R3		; Спрайт ключа
020116: JMP    	025402			; Вывод спрайта
; Спрайт ключа
020122:	.BYTE	353,001,257,037,373,001,277,000,000,000

; Подпрограмма: Скроллирование поезда вправо
020134: MOV    	#100240, R3
020140: MOV    	#000015, R4		; .13 строк
020144: MOV    	R3, R2
020146: INC    	R2
020150: MOVB   	(R2), R0
020152: MOV    	#000037, R1		; Счётчик = 31.
020156: INC    	R2
020160: INC    	R3
020162: MOVB   	-(R3), -(R2)		; копируем-сдвигаем вправо
020164: SOB    	R1, 020162		; повторяем цикл по строке
020166: MOVB   	R0, -(R2)
020170: ADD    	#000076, R3
020174: SOB    	R4, 020144		; повторяем цикл по строкам
; Сдвигаем объекты -- они движутся вместе с вагонами
020176: MOV    	#100100, R3		; Адрес 4-х записей объектов
020202: MOVB   	(R3), R0
020204: INCB   	R0
020206: BEQ    	020240
020210: DECB   	R0
020212: BEQ    	020220
020214: INCB   	000002(R3)
020220: TSTB   	000005(R3)
020224: BEQ    	020232
020226: INCB   	000006(R3)
020232: ADD    	#000010, R3		; к следующей записи
020236: BR     	020202			; повторяем
; Сдвигаем остальное
020240: INCB   	@#100063		; позиция змея -- двигается вместе с вагоном
020244: INCB   	@#100142		; привидение на 1 правее -- двигается с вагоном
020250: MOVB   	@#100154, R0
020254: INCB   	R0			; На 1 правее
020256: MOVB   	R0, @#100154
020262: SUB    	#000040, R0
020266: BIC    	#177400, R0
020272: BNE    	020320
020274: MOVB   	R0, @#100154		; 0 -> (100154)
020300: INCB   	@#100155		; номер вагона ++
020304: MOVB   	@#100142, R0
020310: SUB    	#000040, R0		; на строку выше
020314: MOVB   	R0, @#100142
020320: RETURN 	
; Подпрограмма: Скроллирование поезда влево
020322: MOVB	@#100155, R0		; номер вагона
020326: BISB	@#100154, R0
020332: BEQ	020320
020334: MOV	#100203, R3
020340: MOV	#100202, R2		; Адрес блока тайлов поезда
020344: MOV	#000015, R4		; 13. строк
020350: MOVB	(R2), R0
020352: MOV	#000037, R1		; 31.
020356: MOVB	(R3)+, (R2)+
020360: SOB	R1, 020356
020362: MOVB	R0, (R2)+
020364: INC	R3
020366: SOB	R4, 020350
020370: MOV	#100100, R3		; Адрес 4-х записей объектов
020374: MOVB	(R3), R0
020376: INCB	R0
020400: BEQ	020432
020402: DECB	R0
020404: BEQ	020412
020406: DECB	000002(R3)
020412: TSTB	000005(R3)
020416: BEQ	020424
020420: DECB   	000006(R3)
020424: ADD	#000010, R3
020430: BR	020374
020432: DECB	@#100063		; позиция змея на 1 левее
020436: DECB	@#100142		; на 1 левее
020442: MOVB	@#100154, R0
020446: DECB	R0
020450: MOVB	R0, @#100154
020454: INCB	R0
020456: BNE	020516
020460: MOVB	@#100155, R0		; номер вагона
020464: BEQ	020520			; вагон 000 => переходим
020466: DECB	R0			; номер вагона --
020470: MOVB	R0, @#100155
020474: MOVB	#000037, @#100154
020502: MOVB	@#100142, R0
020506: ADD	#000040, R0		; на строку ниже
020512: MOVB	R0, @#100142
020516: RETURN	
020520: CLRB   	@#100154
020524: RETURN	
; Подпрограмма: Что-то со звуком
020526: INC	@#100156
020532: MOV	@#100156, R3
020536: MOVB	(R3), R0
020540: CMPB	R0, #000377
020544: BNE	020556
020546: MOV	#020616, R3
020552: MOV	R3, @#100156
020556: TSTB	R0
020560: BEQ	020524
020562: MOVB	@#100155, R0		; номер вагона
020566: BISB	@#100154, R0
020572: BEQ	020524
020574: TSTB	@#100035		; демо-режим?
020600: BNE	020524			; да => выход
020602: MOV	#000702, R2
020606: MOV	#000002, R1
020612: JMP	034300			; Звук и RETURN
020616:

; Подпрограмма: Подготовка блока тайлов поезда
020644: MOV	#027040, R3		; Адрес блока тайлов поезда, начальное состояние
020650: MOV	#100202, R2		; Адрес блока тайлов поезда
020654: MOV	#000640, R1		; 416. -- 13 строк
020660: MOVB	(R3)+, (R2)+		;   копируем
020662: SOB	R1, 020660		; повторяем
020664: MOVB	@#100006, R0		; фаза игры
020670: BIC	#177400, R0
020674: DECB	R0
020676: BNE	020702			; в вагоне => переходим
020700: RETURN	
020702: MOV    	#027700, R3		; Адрес блока тайлов
020706: MOV    	#100242, R2		; куда копировать
020712: MOV    	#000400, R1
020716: MOVB   	(R3)+, (R2)+
020720: SOB    	R1, 020716		; повторяем
020722: RETURN 	
; Подпрограмма: Скроллирующийся фон
020724: MOV	#101506, R1
020730: MOV	@#100162, R3
020734: ADD	#021126, R3
020740: MOV	#000040, R0
020744: MOV	R0, R2
020746: CMPB	R0, (R3)
020750: BEQ	020754
020752: MOVB	(R3), (R1)
020754: INC	R3
020756: INC	R1
020760: SOB	R2, 020746
020762: MOV	@#100162, R3
020766: ADD	#021323, R3
020772: MOV	#000040, R0
020776: MOV	R0, R2
021000: CMPB	R0, (R3)
021002: BEQ	021012
021004: CMPB	R0, (R1)
021006: BNE	021012
021010: MOVB	(R3), (R1)
021012: INC	R3
021014: INC	R1
021016: SOB	R2, 021000
021020: MOV	R1, -(SP)
021022: MOV	@#100162, R3
021026: ADD	#021323, R3
021032: MOV	#000041, R1
021036: MOV	#000370, R0
021042: CMPB	R0, (R3)+
021044: BEQ	021054
021046: SOB	R1, 021042
021050: MOV	(SP)+, R1
021052: RETURN	
021054: DEC	R1
021056: MOV	R1, R2
021060: MOV	(SP)+, R1
021062: MOV	#000040, R3
021066: SUB	R2, R3
021070: ADD	#177640, R3
021074: ADD	R3, R1
021076: MOV	#000020, R2
021102: CMPB	(R1), #000040
021106: BNE	021114
021110: MOVB	#000370, (R1)
021114: ADD	#000040, R1
021120: SOB	R2, 021102
021122: RETURN	

; Подпрограмма: Обработка счётчика 100162
021520: SUB	#000002, @#100162
021526: MOV	@#100162, R3
021532: ADD	#021126, R3
021536: TSTB	(R3)
021540: BNE	021550
021542: MOV	#000124, @#100162
021550: RETURN	
; Подпрограмма: Балка
021552: TSTB	@#100164		; На экране есть балка?
021556: BNE	021564			;   да => переходим
021560: JMP	021760			;   нет => переходим
021564: MOVB   	@#100165, R0		; положение балки X
021570: CMPB   	R0, #000040		; за пределами строки?
021574: BHIS   	022000			;   да => переходим
021576: MOVB   	R0, 034564		; X
021602: MOVB   	#000006, 034565		; Y = 6
021610: MOV    	#000020, R2		; Счётчик цикла = 16.
021614: CALL   	033362			; Получаем в R1 адрес в образе экрана
021620: MOV    	R1, -(SP)		; сохраняем R1
021622: MOVB   	(R1), R0		; Начало цикла: Берём тайл с экрана
021624: CMPB   	R0, #000040		;   пустой?
021630: BEQ    	021646			;   да => переходим
021632: CMPB   	R0, #000371		;   >= 371 (тайл балки)
021636: BHIS   	021652
021640: CMPB   	R0, #000360		;   < 360 (360..367 -- тайлы провода)
021644: BLO    	021652
021646: MOVB   	#000371, (R1)		;   записываем тайл балки в экран
021652: ADD    	#000040, R1		;   к следующей строке
021656: SOB    	R2, 021622		; повторяем
021660: MOV    	(SP)+, R1		; восстанавливаем R1
021662: MOVB   	@#100165, R2		; положение балки X
021666: BIC    	#177400, R2
021672: ASR    	R2			; \
021674: ASR    	R2			; поделить на 4
021676: SUB    	#000004, R2		; 4 - R2 -> R2
021702: TSTB   	R2
021704: BEQ    	022000
021706: BMI    	021716
021710: MOV    	#000001, R3
021714: BR     	021724
021716: MOV    	#177777, R3
021722: NEGB   	R2
021724: BIC    	#177400, R2
021730: MOVB   	@#100165, R0		; Положение балки X
021734: BIC    	#177400, R0
021740: CMPB   	R0, #000040
021744: BHIS   	021752
021746: MOVB   	#000371, (R1)
021752: ADD    	R3, R1
021754: ADD    	R3, R0
021756: SOB    	R2, 021734		; повторяем
021760: TSTB	@#100167
021764: BEQ	021770
021766: RETURN	
021770: CMPB   	@#100166, #000024	; скоро будет балка?
021776: BHIS   	021766			; ещё далеко => выходим
022000: CMPB   	@#100022, #000003
022006: BHIS   	021766
022010: MOVB   	@#100006, R0
022014: DECB   	R0
022016: BNE    	021766
022020: TSTB   	@#100035		; демо-режим?
022024: BNE    	021766			; да => выходим
022026: TSTB   	@#100034
022032: BNE    	021766
022034: MOV    	#101224, R1		; Адрес в экран план
022040: MOV    	#022160, R3		; Адрес спрайта CAUTION
022044: JMP    	034366			; Печать строки
; Подпрограмма: Вывод балки на экран
022050: TSTB	@#100164		; На экране есть балка?
022054: BEQ	022156			; нет => выходим
022056: MOVB   	@#100165, R0		; Положение балки X
022062: BIC    	#177400, R0
022066: MOV    	R0, 034560
022072: ASR    	R0
022074: ASR    	R0
022076: SUB    	#000004, R0
022102: ADD    	034560, R0
022106: BIC    	#177400, R0
022112: CMPB   	R0, #000040		; за границей экрана?
022116: BHIS   	022156			;   да => выходим
022120: MOVB   	R0, 034564		; X
022124: MOVB   	#000006, 034565		; Y = 6
022132: MOV    	#000022, R2		; счётчик = 18.
022136: CALL   	033362			;   Получаем в R1 адрес в образе экрана
022142: MOV    	#000371, R0		;   тайл балки
022146: MOVB   	R0, (R1)		;   выводим на экран
022150: ADD    	#000040, R1		;   следующая строка
022154: SOB    	R2, 022146		; повторяем
022156: RETURN	
; Спрайт CAUTION
022160: DB	2, 1, 3, 037, 022, 1, 023, 2
022170: DB	0, "CAUTION!", 0
;
; Подпрограмма: Появление и движение балки
022202: TSTB	@#100164		; Балка уже есть?
022206: BNE	022234			; да => переходим
022210: DEC	@#100166		; уменьшаем счётчик
022214: BNE	022232			; не ноль => выходим
022216: MOVB   	#000001, @#100164	; Появилась балка, ставим признак
022224: MOVB   	#000001, @#100165	; Появилась балка, X = 1
022232: RETURN	
022234: MOVB   	@#100165, R0		; Положение балки X
022240: ADD    	#000002, R0		; вправо на 2 позиции
022244: MOVB   	R0, @#100165		; сохраняем Положение балки X
022250: CMPB   	R0, #000040		; за пределами строки?
022254: BLO    	022232			; нет => выходим
022256: CLRB   	@#100164		; убираем балку
022262: MOV    	@#100170, R3
022266: MOVB   	(R3)+, 034566
022272: MOVB   	(R3)+, 034567
022276: MOV    	034566, R2
022302: MOV    	R3, @#100170
022306: MOV    	R2, @#100166		; устанавливаем счётчик появления балки
022312: BNE    	022232
022314: MOV    	#031240, R3
022320: BR     	022266
; Подпрограмма: Скопировать блок тайлов поезда в 448. байт
022322: MOV	#100202, R3		; Адрес блока тайлов поезда
022326: MOV	#101606, R2		; Экран план, 10.-я строка
022332: MOV	#000700, R1		; 448. = 14 строк по 32 тайла
022336: MOVB	(R3)+, (R2)+		;   копируем
022340: SOB	R1, 022336		; повторяем
022342: TSTB	@#100155		; Номер вагона
022346: BEQ	022352			; вагон 000 => переходим
022350: RETURN	
022352: MOVB	@#100154, R0
022356: BIC	#177400, R0
022362: MOV	#000040, R2
022366: SUB	R0, R2
022370: BIC	#177400, R2
022374: MOVB	R0, 034564		; X
022400: MOVB	#000012, 034565		; Y
022406: CALL	033362			; Получаем в R1 адрес в образе экрана
022412: MOV	#000014, R3		; 12.
022416: MOV	#000040, R0
022422: MOV	R2, R4
022424: MOVB	R0, (R1)+
022426: SOB	R4, 022424
022430: MOVB	@#100154, R4
022434: BIC	#177400, R4
022440: BEQ	022444
022442: ADD	R4, R1
022444: SOB	R3, 022416
022446: MOV	#000147, R0
022452: MOV	R2, R4
022454: MOVB	R0, (R1)+
022456: SOB	R4, 022454
022460: RETURN	
; Подгрограмма: Рисуем тамбур-переход поверх уже выведенных тайлов
022462: MOVB   	@#100006, R0		; фаза игры
022466: DECB   	R0			; \
022470: BEQ    	022614			; На крыше => выходим
022472: TSTB   	@#100155		; Номер вагона
022476: BEQ    	022614			; вагон 000 => выходим
022500: MOVB   	@#100154, 034564
022506: DECB   	034564
022512: MOVB   	#000014, 034565
022520: MOV    	#000347, R2
022524: MOV    	#000007, R4
022530: CALL   	022616
022534: INCB   	034564			; X++
022540: MOV    	#000150, R2
022544: MOV    	#000007, R4
022550: CALL   	022616
022554: INCB   	034564			; X++
022560: MOV    	#000150, R2
022564: MOV    	#000007, R4
022570: CALL   	022616
022574: INCB   	034564			; X++
022600: MOV    	#000347, R2
022604: MOV    	#000007, R4
022610: CALL   	022616
022614: RETURN 	
; Подпрограмма; R2=тайл, R4=счётчик
022616: MOV    	034564, -(SP)		; сохраняем X
022622: MOVB   	034564, R0		; X
022626: BIC    	#177400, R0
022632: CMPB   	R0, #000040		; 32.
022636: BLO    	022662
022640: CMPB   	R0, #000200
022644: BHIS   	022654
022646: SUB    	#000040, R0
022652: BR     	022626
022654: ADD    	#000040, R0
022660: BR     	022626
022662: MOVB   	R0, 034564		; X
022666: CALL   	033362			; Получаем в R1 адрес в образе экрана
022672: MOVB   	R2, (R1)
022674: ADD    	#000040, R1		; на строку ниже
022700: DECB   	R4
022702: BNE    	022672			; не 0 => повторяем
022704: MOV    	(SP)+, 034564		; восстанавливаем X
022710: RETURN 	
; Подрограмма: Скроллинг насыпи под поездом
022712: MOVB	@#101074, 034562
022720: MOVB	@#101075, R0
022724: MOV	#101100, R3
022730: MOV	#101102, R2
022734: MOV	#000036, R1
022740: MOVB	-(R3), -(R2)
022742: SOB	R1, 022740
022744: MOVB	R0, -(R2)
022746: MOVB	034562, -(R2)
022752: RETURN	
; Подпрограмма: Уменьшаем оставшееся время
022754: TSTB	@#100026		; Быстрый счётчик времени = 0 ?
022760: BEQ	022764			; да => переходим
022762: RETURN				;
022764: TSTB	@#100004		; Время закончилось?
022770: BNE	022774			; нет => переходим
022772: RETURN 				;
022774: DECB	@#100004		; Уменьшаем счётчик времени
023000: RETURN				;
; Подпрограмма
023002: TSTB	@#100034		; Режим игры
023006: BEQ	023012
023010: RETURN 	
023012: TSTB	@#100004		; Время закончилось?
023016: BNE	023030			; нет => переходим
023020: MOVB   	#000377, @#100034
023026: RETURN 	
023030: CMPB	@#100042, #000007	; Положение человечка Y = 7 ?
023036: BNE	023070
023040: MOV	#101625, R1		; Адрес на экране план под человечком
023044: MOV	#000040, R2
023050: CMPB	(R1)+, R2		; под ним пусто?
023052: BNE	023140			; нет => переходим
023054: CMPB   	(R1), R2		; под ним пусто?
023056: BNE    	023140			; нет => переходим
023060: MOVB   	#000001, @#100034
023066: RETURN 	
023070: CMPB   	@#100042, #000007	; Положение человечка Y = 7 ?
023076: BHIS   	023140
023100: TSTB   	@#100164		; На экране есть балка?
023104: BEQ    	023140			;   нет => переходим
023106: MOVB   	@#100165, R0		; положение балки X
023112: SUB    	#000017, R0		; минус 15.
023116: BIC    	#177400, R0
023122: CMPB   	R0, #000002		; больше 2?
023126: BHIS   	023140
023130: MOVB   	#000002, @#100034
023136: RETURN 	
023140: MOV	#100100, R5		; Адрес 4-х записей объектов
023144: MOV	#000010, R2
023150: MOVB	(R5), R0
023152: BIC	#177400, R0
023156: CMPB	R0, #000377
023162: BNE	023170
023164: JMP	023436
023170: CMPB	R0, #000002
023174: BLO	023362
023176: CMPB	R0, #000004
023202: BEQ	023362
023204: MOVB	000002(R5), R0		; (100102)
023210: SUB	#000015, R0
023214: BIC	#177400, R0
023220: CMPB	R0, #000004
023224: BHIS	023322
023226: CMPB   	@#100042, #000005	; Положение человечка Y = 5 ?
023234: BEQ    	023246
023236: MOVB   	#000003, @#100034
023244: RETURN 	
023246: MOVB   	#000004, (R5)
023252: INCB   	000002(R5)		; (100102)
023256: INCB   	000003(R5)		; (100103)
023262: MOVB   	#000006, 000004(R5)	; (100104)
023270: MOVB   	#000001, @#100040
023276: MOV    	#033030, @#100032
023304: TSTB   	@#100035		; демо-режим?
023310: BNE    	023320			; да => переходим
023312: ADD    	#000012, @#100000
023320: RETURN 	
023322: MOVB	@#100065, R0
023326: DECB	R0
023330: BNE	023362
023332: MOVB   	@#100063, R0		; позиция змея
023336: MOVB   	000002(R5), R4		; (100102)
023342: SUB    	R4, R0
023344: BIC    	#177400, R0
023350: CMPB   	R0, #000003
023354: BHIS   	023362
023356: JMP    	023246
023362: TSTB	000005(R5)		; (100105)
023366: BEQ	023430
023370: MOVB	000006(R5), R0		; (100106)
023374: SUB	#000017, R0
023400: CMPB	R0, #000002
023404: BHIS	023430
023406: TSTB	@#100044
023412: BNE	023430
023414: MOVB	#000004, @#100034
023422: CLRB	000005(R5)		; (100105)
023426: RETURN	
023430: ADD	R2, R5
023432: JMP	023150
023436: MOVB	@#100065, R0
023442: DECB	R0
023444: BNE	023502
023446: MOVB   	@#100063, R0		; позиция змея
023452: SUB    	#000015, R0
023456: CMPB   	R0, #000004
023462: BHIS   	023502
023464: MOVB   	#000005, @#100034
023472: MOVB   	#000002, @#100065
023500: RETURN 	
023502: TSTB	@#100074
023506: BEQ	023604			; на выход
023510: MOVB	@#100073, R0
023514: SUB	#000015, R0
023520: CMPB	R0, #000004
023524: BHIS	023604			; на выход
023526: MOVB	@#100042, R0		; Положение человечка Y
023532: SUB	#000005, R0
023536: BIC	#177400, R0
023542: BNE	023604			; на выход
023544: MOVB   	@#100054, R0
023550: BNE    	023604			; на выход
023552: MOVB   	R0, @#100074
023556: MOVB   	R0, @#100075
023562: INC    	R0
023564: MOVB   	R0, @#100054
023570: MOVB   	R0, @#100040
023574: MOV    	#032724, @#100032
023602: RETURN 	
023604: RETURN	
; Подпрограмма
023606: TSTB   	@#100034
023612: BNE    	023630
023614: TSTB   	@#100004		; Время закончилось?
023620: BNE    	023632			; нет => переходим
023622: MOVB   	#000377, @#100034
023630: RETURN 	
023632: TSTB   	@#100155		; Номер вагона
023636: BNE    	023666			; не ноль => переходим
023640: CMPB   	@#100154, #000022
023646: BNE    	023666
023650: MOVB   	#000001, @#100034
023656: MOVB   	#000025, @#100042	; Положение человечка Y = 23.
023664: RETURN 	
023666: TSTB   	@#100036
023672: BEQ    	023700
023674: JMP    	024212
023700: CMPB   	@#100155, #000023
023706: BNE    	023724
023710: CMPB   	@#100154, #000022
023716: BNE    	023724
023720: JMP    	026474			; Переход на какой-то отдельный игровой цикл
023724: MOV    	#100100, R5		; Адрес 4-х записей объектов
023730: MOV    	#000010, R2
023734: MOVB   	(R5), R0
023736: CMPB   	R0, #000377
023742: BNE    	023750
023744: JMP    	024212
023750: CMPB   	R0, #000002
023754: BLO    	024120
023756: CMPB   	R0, #000004
023762: BEQ    	024120
023764: MOVB   	000002(R5), R0
023770: SUB    	#000016, R0
023774: BIC    	#177400, R0
024000: CMPB   	R0, #000003
024004: BHIS   	024120
024006: MOVB   	@#100042, R0		; Положение человечка Y
024012: CMPB   	R0, #000016
024016: BLO    	024120
024020: CMPB   	R0, #000020
024024: BLO    	024036
024026: MOVB   	#000003, @#100034
024034: RETURN 	
024036: MOVB   	#000004, (R5)
024042: MOVB   	#000010, 000001(R5)
024050: INCB   	000002(R5)
024054: INCB   	000003(R5)
024060: MOVB   	#000010, 000004(R5)
024066: MOVB   	#000001, @#100040
024074: MOV    	#033030, @#100032
024102: TSTB   	@#100035		; демо-режим?
024106: BNE    	024116			; да => выходим
024110: ADD    	#000012, @#100000
024116: RETURN 	
024120: TSTB   	000005(R5)
024124: BEQ    	024204
024126: MOVB   	000006(R5), R0
024132: SUB    	#000017, R0
024136: BIC    	#177400, R0
024142: CMPB   	R0, #000002
024146: BHIS   	024204
024150: MOVB   	@#100042, R0		; Положение человечка Y
024154: CMPB   	R0, #000016
024160: BLO    	024204
024162: CMPB   	R0, #000021
024166: BEQ    	024204
024170: MOVB   	#000004, @#100034
024176: CLRB   	000005(R5)
024202: RETURN 	
024204: ADD    	R2, R5
024206: JMP    	023734
024212: CMPB   	@#100042, #000017	; Положение человечка Y = 15. ?
024220: BHIS   	024314
024222: MOVB   	@#100041, R1		; Положение человечка X
024226: MOVB   	@#100142, R0
024232: BIC    	#177400, R0
024236: CMPB   	R0, #000040
024242: BLO    	024266
024244: CMPB   	R0, #000200
024250: BHIS   	024260
024252: SUB    	#000040, R0
024256: BR     	024232
024260: ADD    	#000040, R0
024264: BR     	024232
024266: SUB    	R1, R0
024270: INCB   	R0
024272: BIC    	#177400, R0
024276: CMPB   	R0, #000003
024302: BHIS   	024314
024304: MOVB   	#000005, @#100034
024312: RETURN 	
024314: TSTB   	@#100036
024320: BEQ    	024464
024322: MOVB   	@#100042, R0		; Положение человечка Y
024326: CMPB   	R0, #000016
024332: BHIS   	024402
024334: MOVB   	@#100041, R0		; Положение человечка X
024340: SUB    	#000017, R0
024344: CMPB   	R0, #000003
024350: BHIS   	024402
024352: TSTB   	@#100037
024356: BNE    	024402
024360: MOVB   	#000001, @#100037
024366: MOVB   	#000001, @#100040
024374: MOV    	#032756, @#100032
024402: MOVB   	@#100041, R1		; Положение человечка X
024406: MOVB   	@#100147, R0
024412: SUB    	R1, R0
024414: INCB   	R0
024416: BIC    	#177400, R0
024422: CMPB   	R0, #000003
024426: BHIS   	024464
024430: MOVB   	@#100042, R1		; Положение человечка Y
024434: MOVB   	@#100150, R0
024440: SUB    	R1, R0
024442: INCB   	R0
024444: BIC    	#177400, R0
024450: CMPB   	R0, #000004
024454: BHIS   	024464
024456: MOVB   	#000006, @#100034
024464: RETURN 	
; Подпрограмма: Печать индикаторной строки вверху экрана
024466: MOV	#101110, R1		; Адрес в образе экрана план
024472: MOV	#024742, R3		; Адрес строки "TOP   SCORE TIME CAR STG"
024476: CALL	034366			; Печать строки
024502: MOV	@#100000, R2
024506: MOV	@#100002, R3
024512: SUB	R2, R3
024514: BHIS	024522
024516: MOV    	R2, @#100002
024522: MOV	#101146, R1		; Адрес на экране?
024526: MOV	@#100002, R3		; Top score
024532: CALL	034400			; Вывод 5-значного десятичного числа
024536: INC	R1
024540: MOV	@#100000, R3		; Score
024544: CALL	034400			; Вывод 5-значного десятичного числа
024550: INC	R1
024552: INC	R1
024554: MOVB	@#100004, R0		; Time -- оставшееся время
024560: CALL	034476			; Вывод 3-значного десятичного числа
024564: INC	R1
024566: MOVB	@#100155, R0		; Car -- номер вагона
024572: BNE	024606
024574: MOV	#024736, R3		; Адрес строки "   "
024600: CALL	034366			; Печать строки
024604: BR	024624
024606: NEGB	R0
024610: BIC	#177400, R0		; оставить только младший байт
024614: ADD	#000024, R0		; +20.
024620: CALL	034476			; Вывод 3-значного десятичного числа
024624: INC	R1
024626: MOVB	@#100007, R0		; Stage
024632: CALL	034476			; Вывод 3-значного десятичного числа
024636: MOVB	@#100010, R0		; Lives
024642: BIC	#177400, R0
024646: DECB	R0			; рисовать будем не более 2-х человечков
024650: BPL	024654
024652: RETURN 	
024654: BNE	024660
024656: RETURN 	
024660: MOVB	R0, R4
024662: MOVB	#000036, R2
024666: MOV	R2, -(SP)		; Начало цикла рисования человечков
024670: MOVB	R2, 034564		; X
024674: CLRB	034565			; Y = 0
024700: CALL	033362			; Получаем в R1 адрес в образе экрана
024704: MOV	#011626, R3		; Спрайт голова человечка, смотрит влево
024710: CALL	025402			; Вывод спрайта: голова человечка
024714: CALL	025402			; Вывод спрайта: тело человечка
024720: MOV	(SP)+, R2
024722: SUB	#000003, R2
024726: BIC	#177400, R2
024732: SOB	R4, 024666		; Конец цикла рисования человечков
024734: RETURN	
024736: DB      "   ", 000
024742: DB      "TOP   SCORE TIME CAR STG", 000
; Подпрограмма: если демо-режим, то GAME OVER
024774: TSTB	@#100035		; демо-режим?
025000: BNE	025004			; да => переходим
025002: RETURN				;
025004: MOV    	#101261, R1		; Адрес в экран план
025010: MOV    	#025172, R3		; Адрес строки GAME OVER
025014: CALL   	034366			; Печать строки
025020: MOV    	#101306, R1
025024: MOVB   	@#100013, 034570
025032: MOVB   	@#100014, 034571
025040: MOV    	034570, R3
025044: MOV    	#000040, R2
025050: MOVB   	(R3)+, R0
025052: BNE    	025062
025054: MOV    	#025206, R3		; Адрес бегущей строки для демо-режима
025060: BR     	025050
025062: MOVB   	R0, (R1)+
025064: SOB    	R2, 025050
025066: TSTB   	@#100020
025072: BEQ    	025076
025074: RETURN 	
025076: MOVB   	@#100013, 034570
025104: MOVB   	@#100014, 034571
025112: INC    	034570
025116: MOVB   	034570, @#100013
025124: MOVB   	034571, @#100014
025132: MOV    	034570, R3
025136: TSTB   	(R3)
025140: BEQ    	025144
025142: RETURN 	
025144: MOV    	#025206, R3		; Адрес бегущей строки для демо-режима
025150: MOV    	R3, 034570
025154: MOVB   	034570, @#100013
025162: MOVB   	034571, @#100014
025170: RETURN 	
;
025172: DB      "GAME   OVER", 000
; Бегущая строка для демо-режима
025206: DB      "           STOP THE "ITA EXPRESS"   "
025252: DB      " [J] OR [K] FOR JOYSTICK OR KEYBOARD    "
025322: DB      "COPYRIGHT @ 1990 BY  LWOW  SOFT", 000

; Подпрограмма: Вывод спрайта; R3=спрайт, R1=адрес на экран план
025402: MOVB	(R3), R0
025404: BNE	025416			; не конец => переходим
025406: INC	R3
025410: MOVB	R0, @#101103
025414: RETURN	
025416: MOVB	@#101103, R0
025422: BIC	#177400, R0
025426: MOVB	(R3)+, 034560
025432: ADD	034560, R0
025436: MOVB	R0, (R1)
025440: MOVB	(R3)+, R2
025442: BIC	#177400, R2
025446: ADD	R2, R1
025450: JMP	025402			; повторяем
; Подпрограмма: Увеличить счётчики
025454: MOVB	@#100015, 034560
025462: MOV	#000001, R0
025466: XOR	R0, 034560
025472: MOVB	034560, @#100015
025500: MOV	#100016, R3		; Счётчик
025504: CALL	025554
025510: MOV	#100020, R3		; Счётчик
025514: CALL	025554
025520: MOV	#100022, R3		; Счётчик
025524: CALL	025554
025530: MOV	#100024, R3		; Счётчик
025534: CALL	025554
025540: MOV	#100026, R3		; Быстрый счётчик времени
025544: CALL	025554
025550: MOV	#100030, R3		; Счётчик
025554: INCB	(R3)			; Увеличить счётчик R3
025556: CMPB	(R3), 000001(R3)	; дошли до лимита?
025562: BLO	025566			; нет => выходим
025564: CLRB	(R3)			; очищаем счётчик
025566: RETURN	
025570: RETURN	
025572: RETURN	
;
025574: TSTB	@#100035		; демо-режим?
025600: BEQ	025604			;   нет => переходим
025602: RETURN 				;   да => выходим
025604: TSTB	@#100040
025610: BNE	025614
025612: RETURN	
025614: MOV	@#100032, R3
025620: MOVB	000001(R3), R0
025624: INCB	R0
025626: BNE	025636
025630: MOVB	R0, @#100040
025634: RETURN	
025636: MOVB	(R3)+, 034566
025642: MOVB	(R3)+, 034567
025646: MOV	034566, R2
025652: MOV	R3, @#100032
025656: MOV	#000005, R1
025662: JMP	034300			; Звук и RETURN
;
025666: MOVB	#000001, @#100007	; Stage = 1
025674: MOVB	#000003, @#100010	; Lives = 3
025702: CLR	@#100000		; Score = 0
025706: MOV	#124000, R3		; Начало распакованной последовательности
025712: MOV	R3, 034570
025716: MOVB	034570, @#100011
025724: MOVB	034571, @#100012
025732: RETURN	
; Подпрограмма: Подготовка переменных и объектов для фазы на крыше
025734: CALL	026344
025740: CLRB	@#100164		; Балки на экране нет
025744: CLRB	@#100075
025750: CLRB	@#100074
025754: CLRB	@#100054
025760: CLRB	@#100065
025764: CLRB	@#100071
025770: MOVB	#000001, @#100006	; На крыше
025776: MOVB	#000001, @#100155	; Номер вагона
026004: MOV	#003417, R1
026010: MOVB	#000017, @#100041	; Положение человечка X = 15.
026016: MOVB	#000007, @#100042	; Положение человечка Y = 7
026024: MOV	#020616, @#100156
026032: CLR	@#100162		; Счётчик скроллируемого фона
026036: MOV	#031240, R3
026042: MOVB	(R3)+, 034566
026046: MOVB	(R3)+, 034567
026052: MOV	034566, R2
026056: MOV	R3, @#100170
026062: MOV	R2, @#100166		; счётчик появления балки
026066: MOV	#100100, R3		; Адрес 4-х записей объектов
026072: MOV	#000020, R2
026076: MOVB	@#100007, R0		; Stage
026102: MOV	#000004, R1
026106: CMPB	R0, #000003
026112: BHIS	026124
026114: INCB	R0
026116: MOV	R0, R1
026120: BIC	#177400, R1
026124: CLRB	(R3)+			; Очищаем 0-й байт записи объекта
026126: MOVB	R2, (R3)		; 1-й байт
026130: ADD	#000004, R3		; переходим к 5-му байту
026134: CLRB	(R3)			; 5-й очищаем
026136: ADD	#000003, R3		; переходим к следующей записи
026142: ADD	#000040, R2
026146: SOB	R1, 026124
026150: MOVB	#000377, (R3)
026154: RETURN	
; Подпрограмма: Подготовка переменных и объектов для фазы в вагоне
026156: CALL   	026344
026162: CLRB   	@#100143
026166: CLRB   	@#100144
026172: CLRB   	@#100153
026176: MOVB   	#000002, @#100006	; В вагоне
026204: MOVB   	#000003, @#100142	; Положение привидения
026212: MOVB   	#000013, @#100155	; Номер вагона = 11.
026220: MOVB   	#000017, @#100041	; Положение человечка X = 15.
026226: MOVB   	#000020, @#100042	; Положение человечка Y = 16.
026234: MOV    	#017406, 034570		; Адрес начала посл-ти движений привидения
026242: MOVB   	034570, @#100145
026250: MOVB   	034571, @#100146
026256: MOV    	#100100, R3		; Адрес 4-х записей объектов
026262: MOV    	000020, R2	; ????? тут явно ошибка -- см 026072
026266: MOVB   	@#100007, R0		; Stage
026272: MOV    	#000004, R1
026276: CMPB   	#000003, R0
026302: BHIS   	026314
026304: INCB   	R0
026306: MOV    	R0, R1
026310: BIC    	#177400, R1
026314: CLRB   	(R3)+			; Очищаем 0-й байт записи объекта
026316: MOVB   	R2, (R3)+		; 1-й байт
026320: INC    	R3			; 2 пропускаем
026322: INC    	R3			; 3 пропускаем
026324: INC    	R3			; 4 пропускаем
026326: CLRB   	(R3)+			; 5-й очищаем
026330: INC    	R3			; 6 пропускаем
026332: INC    	R3			; 7 пропускаем
026334: ADD    	#000040, R2
026340: SOB    	R1, 026314		; повторяем
026342: RETURN 	
; Подрограмма
026344: CLRB	@#100015
026350: CLRB	@#100016
026354: CLRB	@#100020
026360: CLRB	@#100022
026364: CLRB	@#100030
026370: CLRB	@#100034
026374: CLRB	@#100043
026400: CLRB	@#100044
026404: CLRB	@#100045
026410: CLRB	@#100046
026414: CLRB	@#100047
026420: CLRB	@#100050		; DX = 0
026424: CLRB	@#100050		; DX = 0
026430: CLRB	@#100051
026434: CLRB	@#100154
026440: CLRB	@#100005
026444: CLRB	@#100036
026450: CLRB	@#100040
026454: CLRB	@#100037
026460: CLRB	@#100055
026464: MOVB	#000310, @#100004	; Начальное время = 200.
026472: RETURN	
;
026474: CALL   	025570
026500: MOV    	#001000, @#100174
026506: MOVB   	#000003, @#100176
026514: CALL   	033454			; Формирование реального экрана по образу
026520: CALL   	025454			; Увеличить счётчики
026524: CALL   	022322			; Скопировать блок в 448. байт
026530: CALL   	024466
026534: CALL   	020724			; Скроллирующийся фон
026540: CALL   	021552
026544: CALL   	020526			; Звук
026550: CALL   	016762			; Вывод привидения
026554: CALL   	017526
026560: CALL   	011400
026564: CALL   	024774			; Если демо то GAME OVER
026570: CALL   	022712
026574: CALL   	021520			; Обработка счётчика 100162 скроллируемого фона
026600: CALL   	022202			; Появление и движение балки
026604: CALL   	017154
026610: TSTB   	@#100015
026614: BNE    	026514
026616: CALL   	020134			; Скроллирование поезда вправо
026622: CALL   	026740
026626: INCB   	@#100041
026632: TSTB   	@#100154
026636: BNE    	026514
026640: CALL   	025570
026644: MOVB   	#000001, @#100036
026652: MOVB   	#000035, @#100147
026660: MOVB   	#000013, @#100150
026666: MOVB   	#000377, @#100151
026674: MOVB   	#000001, @#100152
026702: CLR    	@#100044
026706: CLR    	@#100046
026712: CLRB   	@#100043
026716: CLR    	@#100050
026722: MOVB   	#000035, @#100041
026730: MOVB   	#000020, @#100042
026736: RETURN 	
;
026740: TSTB   	@#100035
026744: BNE    	027032
026746: MOV    	@#100174, R3
026752: MOV    	R3, R2
026754: MOV    	#000005, R1
026760: TSTB   	@#100176
026764: BEQ    	026772
026766: CALL   	034300
026772: ADD    	#177740, R3
026776: MOV    	R3, @#100174
027002: MOVB   	@#100176, R0
027006: CMPB   	R0, #000017
027012: BEQ    	027032
027014: CMPB   	R0, #000011
027020: BHIS   	027034
027022: ADD    	#000003, R0
027026: MOVB   	R0, @#100176
027032: RETURN 	
027034: INCB   	R0
027036: BR     	027026
;
; Блок тайлов поезда, начальное состояние, 416. байт, 13 строк по 32 тайла
027040:

031200: DB

031240: DB

031264: DB	

032664: ASCII	/        THIS GAME IS FICTION .../

; Подпрограмма: Очистка переменных
033102: CLR	R0
033104: MOVB	R0, @#100015
033110: MOVB	R0, @#100141
033114: MOVB	R0, @#101102
033120: MOVB	R0, @#101103
033124: DEC	R0
033126: MOVB	R0, @#100140
033132: MOV	#001400, R3
033136: MOV	R3, @#100016
033142: MOV	#002000, R3
033146: MOV	R3, @#100020
033152: MOVB	R3, @#100061
033156: MOVB	R3, @#100067
033162: MOV	R3, @#100076
033166: SWAB	R3
033170: MOVB	R3, @#100062
033174: MOVB	R3, @#100070
033200: MOV	#003000, @#100022	; Быстрый счётчик
033206: MOV	#004000, @#100024	; Быстрый счётчик
033214: MOV	#006400, @#100026	; Быстрый счётчик времени
033222: MOV	#010000, @#100030	; Быстрый счётчик
033230: CLR	@#100002		; Top score = 0
033234: MOV	#031200, R3		; Откуда копировать
033240: MOV	#101042, R2		; куда
033244: MOV	#000040, R1		; 32. раза
033250: MOVB	(R3)+, (R2)+		;   копируем байт
033252: SOB	R1, 033250		; повторяем
033254: RETURN	
; Подпрограмма
033256: CALL	033420			; Очистка образа экрана
033262: CLRB	@#101105
033266: MOV	#034604, R3		; блок 200 тайлов с 000
033272: CALL	033302			; Скопировать тайлы
033276: JMP	033454			; Формирование реального экрана по образу
; Подпрограмма; Скопировать тайлы; параметр R3 = адрес откуда копировать
033302: MOVB	(R3)+, R0		; берём номер тайла с которого начинать
033304: MOVB	(R3)+, R1		; берём количество тайлов
033306: BIC	#177400, R0		; только младший байт
033312: BIC	#177400, R1		; только младший байт
033316: MOV	R0, R2			; \
033320: ASL	R0			; \
033322: ASL	R0			; \
033324: ASL	R0			; \
033326: ADD	R2, R0			; R0 = R0 * 9
033330: MOV	#104106, R2		; адрес начала блока тайлов
033334: ADD	R2, R0			; получили адрес куда копировать
033336: MOV	R1, R2			; \
033340: ASL	R1			; \
033342: ASL	R1			; \
033344: ASL	R1			; \
033346: ADD	R2, R1			; R1 = R1 * 9 -- получили количество байт
033350: MOVB	(R3)+, (R0)+		;   копируем байт
033352: SOB	R1, 033350		; повторяем
033354: RETURN				;
;
033356: MOV    	R1, 034564
; Подпрограмма: Перевести Z34564 (X) и Z34565 (Y) в адрес в образе экрана
033362: MOV	R5, -(SP)
033364: MOVB	034565, R5		; Y
033370: MOVB	034564, R1		; X
033374: ASL	R5			; \
033376: ASL	R5			; \
033400: ASL	R5			; \
033402: ASL	R5			; \
033404: ASL	R5			; R5 = R5 * 32
033406: ADD	R5, R1
033410: ADD	#101106, R1		; Адрес начала образа экрана
033414: MOV	(SP)+, R5
033416: RETURN	
; Подпрограмма: Очистка образа экрана
033420: MOV	#000040, R0		; Пустой тайл (пробел)
033424: MOV	#101106, R3		; Адрес начала образа экрана план
033430: MOV	#001400, R1		; количество тайлов всего = 32. * 24.
033434: MOVB	R0, (R3)+		;   записываем тайл в образ экрана план
033436: SOB	R1, 033434		; повторяем
033440: MOV	#001400, R1		; Цикл по образу экрана факт
033444: COM	R0			; инвертируем номер тайла
033446: MOVB	R0, (R3)+		;   записываем тайл в образ экрана факт
033450: SOB	R1, 033446		; повторяем
033452: RETURN	
; Подпрограмма: Формирование реального экрана по образу
033454: MOV	R4, -(SP)		;
033456: MOV	R5, -(SP)		;
033460: MOV	#101106, R2		; Начало образа экрана план
033464: MOV	#102506, R3		; Начало образа экрана факт
033470: MOV	#040010, R4		; Адрес в ВОЗУ включенном в память
033474: MOV	#000030, R5		; 24. строки
033500: MOV	R5, -(SP)		; Начало цикла по строкам
033502: MOV	#000040, R5		; 32. символа в строке
033506: BIS	#000200, @#157700
033514: MOV	@#157700, @#177400	; Включаем реальный экран в память
033522: MOVB	(R2), R0		; Начало цикла по строке -- берём номер тайла
033524: CMPB	R0, (R3)		; тайл план совпадает с фактом?
033526: BEQ	033666			; да => пропускаем формирование этого тайла
033530: BIC	#177400, R0		; оставляем младший байт
033534: MOVB	R0, (R3)+		; обновляем факт
033536: MOV	R4, -(SP)		; сохраняем адрес на экране
033540: MOV	R0, R1			; \
033542: ASL	R0			; \
033544: ASL	R0			; \
033546: ASL	R0			; \
033550: ADD	R1, R0			; R0 = R0 * 9
033552: ADD	#104106, R0		; Плюс адрес начала блока тайлов
033556: MOVB	000010(R0), R1		; берём атрибут тайла
033562: MOVB	(R0)+, (R4)+		; 0 строчка
033564: MOVB	R1, (R4)		; атрибут
033566: ADD	#000117, R4		; плюс 79. -- следующая строка экрана
033572: MOVB	(R0)+, (R4)+		; 1 строчка
033574: MOVB	R1, (R4)		;
033576: ADD	#000117, R4		;
033602: MOVB	(R0)+, (R4)+		; 2 строчка
033604: MOVB	R1, (R4)		;
033606: ADD	#000117, R4		;
033612: MOVB	(R0)+, (R4)+		; 3 строчка
033614: MOVB	R1, (R4)		;
033616: ADD	#000117, R4		;
033622: MOVB	(R0)+, (R4)+		; 4 строчка
033624: MOVB	R1, (R4)		;
033626: ADD	#000117, R4		;
033632: MOVB	(R0)+, (R4)+		; 5 строчка
033634: MOVB	R1, (R4)		;
033636: ADD	#000117, R4		;
033642: MOVB	(R0)+, (R4)+		; 6 строчка
033644: MOVB	R1, (R4)		;
033646: ADD	#000117, R4		;
033652: MOVB	(R0)+, (R4)+		; 7 строчка
033654: MOVB	R1, (R4)		; атрибут
033656: ADD	#000117, R4
033662: MOV	(SP)+, R4		; восстанавливаем адрес на экране в R4
033664: BR	033670
033666: MOVB	R0, (R3)+		; обновляем факт
033670: MOVB	#000040, (R2)+		; обновляем план
033674: TST	(R4)+			; к следующей колонке
033676: SOB	R5, 033522		; Конец цикла по строке
033700: BIC	#000200, @#157700
033706: MOV	@#157700, @#177400	; Отключаем реальный экран из памяти
033714: ADD	#001100, R4		; к следующей строке экрана
033720: MOV	(SP)+, R5		; восстанавливаем счётчик по строкам
033722: DEC	R5			;
033724: BNE	033500			; Конец цикла по строкам
033726: MOV	(SP)+, R5		;
033730: MOV	(SP)+, R4		;
033732: RETURN	
;
033734: MOV	@#177542, R0		; Читаем порт B от клавиатуры 7007
033740: COM	R0
033742: BIC	#177760, R0
033746: BEQ	033766
033750: MOV	R3, -(SP)
033752: MOV	#034000, R3
033756: ADD	R0, R3
033760: MOVB	(R3), R0
033762: MOV	(SP)+, R3
033764: RETURN	
033766: CALL   	034020
033772: BIC    	#177737, R0
033776: RETURN 	

034000: DB	000,066,064,000,062,063,061,062,070,071,067,000,000,063,067,000

034020: TSTB   	034224
034024: BNE    	034034
034026: CLR    	R0
034030: RETURN 	
034032: BR     	034020
034034: MOV	@#177542, R0		; Читаем порт B от клавиатуры 7007
034040: COM	R0
034042: BIC	#177757, R0
034046: ASL	R0
034050: RETURN	
034052: TSTB   	034224
034056: BEQ    	034154
034060: MOV    	@#177542, R0		; Читаем порт B от клавиатуры 7007
034064: COM    	R0
034066: BIC    	#177760, R0
034072: BNE    	034076
034074: RETURN 	
034076: MOV    	R1, -(SP)
034100: MOV    	#034114, R1
034104: ADD    	R0, R1
034106: MOVB   	(R1), R0
034110: MOV    	(SP)+, R1
034112: RETURN 	
; Коды для расшифровки скан-кодов клавиатуры 7007
034114: DB	0, 3, 7, 0, 5, 4, 6, 5, 1, 2, 0, 10, 0, 0, 4, 10, 0
034134: DB	"8899663322114477"
034154:

034224: DW				; Признак того что есть символ с клавиатуры

; Подпрограмма: что-то с клавиатурой
; возвращает Z=0 если было нажатие
034226: CALL	001404
034232: CMPB	#000113, R0
034236: BEQ	034272
034240: CMPB	#000112, R0
034244: BEQ	034256
034246: CALL	034034
034252: BNE	034256
034254: RETURN 				; Z=1 -- "нет нажатия"
034256: MOV	#000001, 034224		; Ставим признак есть символ с клавиатуры
034264: MOV	#000377, R0
034270: RETURN				; Z=0 -- "есть нажатие"
034272: CLR    	034224			; Очищаем признак нажатия клавиши
034276: BR     	034264
; Подпрограмма: что-то со звуком
034300: TST	R2
034302: BNE	034306
034304: RETURN	
034306: ASL	R1
034310: MOV	R3, -(SP)
034312: BIS	#000140, @#157706	; Звук вкл
034320: MOV	@#157706, @#177604
034326: CALL	034360
034332: BIC	#000140, @#157706	; Звук выкл
034340: MOV	@#157706, @#177604
034346: CALL	034360
034352: SOB	R1, 034312
034354: MOV	(SP)+, R3
034356: RETURN	
034360: MOV	R2, R3
034362: SOB	R3, 034362
034364: RETURN	
;
; Подпрограмма: Печать строки; R3 = адрес строки; R1 = адрес в экран план
034366: TSTB	(R3)			; не ноль?
034370: BNE	034374			; нет => продолжаем
034372: RETURN				;
034374: MOVB	(R3)+, (R1)+		; копируем в экран план
034376: BR	034366			; продолжаем цикл
;
; Подпрограмма: Печать 5-значного десятичного числа; R3=число
034400: MOV	#023420, R2		; 10000.
034404: CALL	034454			;
034410: MOV	#001750, R2		; 1000.
034414: CALL	034454			;
034420: MOV	#000144, R2		; 100.
034424: CALL	034454			;
034430: MOV	#000012, R2		; 10.
034434: CALL	034454			;
034440: ADD	#000060, R3		; '0'
034444: MOVB	R3, (R1)+		;
034446: MOVB	#000060, (R1)+		;
034452: RETURN				;
034454: MOV	#000060, R0		; '0'
034460: SUB	R2, R3			;
034462: BLO	034470			;
034464: INC    	R0			;
034466: BR     	034460			;
034470: ADD	R2, R3			;
034472: MOVB	R0, (R1)+		; копируем в экран план
034474: RETURN	
; Подпрограмма: Печать 3-значного десятичного числа
034476: BIC	#177400, R0
034502: MOV	R3, -(SP)
034504: MOV	#000144, R2		; 100.
034510: CALL	034536			;
034514: MOV	#000012, R2		; 10.
034520: CALL	034536			;
034524: ADD	#000060, R0		; '0'
034530: MOVB	R0, (R1)+		;
034532: MOV	(SP)+, R3		;
034534: RETURN	
034536: MOV	#000060, R3		; '0'
034542: SUB	R2, R0			;
034544: BLO	034552			;
034546: INC	R3			;
034550: BR	034542			;
034552: ADD	R2, R0			;
034554: MOVB	R3, (R1)+		;
034556: RETURN				;

034560: DB	; ???

034564: DB	; Позиция образа экрана (X)
034565: DB	; Строка образа экрана (Y)

034570: DW	; ??? что-то со вводом клавиатура/джойстик

; Блок из 200 тайлов с 000 тайла
034604: DB	000, 200
...
; Блок из 200 тайлов с 200 тайла
037006: DB	200, 200
...
; Блок из 200 тайлов с 200 тайла
041210: DB	200, 200
...
; Блок из 060 тайлов с 260 тайла
043412: DB	260, 060

100004: DB	; Оставшееся время, начальное значение 200

100007: DB	; Stage
100010: DB	; Lives -- счётчик жизней
100011: DB	; Адрес распакованной последовательности
100012: DB	; // старший байт адреса
100013: DB	; Адрес бегущей строки демо-режима???
100014: DB	; // старший байт адреса
100015: DB	; ???
100016: DW	; Быстрый счётчик
100020: DW	; Быстрый счётчик
100022: DW	; Быстрый счётчик для счётчика 100066
100024: DW	; Быстрый счётчик
100026: DW	; Быстрый счётчик времени
100030: DW	; Быстрый счётчик

100034: DB	; Текущий режим игры 0..6
100035: DB      ; Признак демо-режима: 1 демо, 0 реальная игра
100036: DB      ; 0 / 1

100041: DB	; Положение человечка X
100042: DB	; Положение человечка Y

100046: DB	; ??? что-то с движением человечка
100047: DB	; ??? что-то с движением человечка
100050: DB	; DX движение человечка: -1 влево, 0 нет, 1 вправо
100051: DB	; ??? движение человечка
100052: DW	; Адрес, как-то влияет на Положение человечка Y

100063: DB	; позиция X змея
100064: DB

100066: DB	; ??? счётчик, нач.значение 40.

100072: DB	; ??? что-то со звуком

100155: DB	; ???

100162: DB	; Счётчик скроллируемого фона
	
; Блок тайлов поезда: 448. байт -- 14. строк по 32. байта
100202: DB
101102:

; Образ экрана план -- 24. строки по 32. байта -- номер тайлов
101106: DB
; Образ экрана факт -- 24. строки по 32. байта -- номер тайлов
102506: DB
;
; Блок тайлов 8x8 пикселей, 9 байт на тайл: 8 на данные пикселов, 1 атрибут
104106: DB	; 256. тайлов * 9 = 2304. байт
110506:

; ???
124000:

160004: JMP	175556
175556: MOV	R1, -(SP)
175560: MOV	R2, -(SP)
175562: MOV	R3, -(SP)
175564: MOV	#157770, R1
175570: CALL	177012
175574: BEQ	175624
175612: SEC	
175614: MOV	(SP)+, R3
175616: MOV	(SP)+, R2
175620: MOV	(SP)+, R1
175622: RETURN	
175624: MOV	#000017, R3
175630: BIT	#000002, @#177442	; Состояние клавиатуры
175636: BNE	175644
175640: SOB	R3, 175630
175642: BR	175612
175644:
177012: MOVB	(R1), R2
177014: BIC	#177770, R2
177020: MOVB	(R1), R3
177022: ASR	R3
177024: ASR	R3
177026: ASR	R3
177030: BIC	#177770, R3
177034: CMP	R3, R2
177036: RETURN	
